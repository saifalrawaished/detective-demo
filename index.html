<!doctype html>
<html lang="en" id="rootHtml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detective Demo</title>

  <style>
    :root{
      --bg:#141824;

      --cardTop: rgba(46,52,70,0.92);
      --cardBot: rgba(30,34,50,0.92);

      --panelTop: rgba(50,56,78,0.92);
      --panelBot: rgba(32,36,56,0.92);

      --text:#e8e6dc;
      --muted:#b6b1a2;

      --accent:#c9a24d;
      --accentSoft: rgba(201,162,77,0.35);

      --good:#66d18f;
      --warn:#ffcc66;

      --paper: rgba(240,235,220,0.92);
      --ink: #201c14;

      --shadow: 0 12px 28px rgba(0,0,0,0.40);
      --shadowHover: 0 18px 40px rgba(0,0,0,0.55);

      --focus: 2px solid var(--accent);
      --radius: 14px;
    }

    *{
      box-sizing:border-box;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial,
        "Noto Naskh Arabic", "Noto Sans Arabic", "Geeza Pro", "Tahoma", sans-serif;
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing:0.2px;
    }

    body{
      margin:0;
      color:var(--text);
      background:var(--bg);
      min-height:100vh;
    }

    /* ---------- BACKGROUNDS ---------- */
    body[data-bg="title"]{
      background:
        linear-gradient(rgba(0,0,0,0.18), rgba(0,0,0,0.40)),
        url("image0.jpg") center / cover no-repeat;
    }
    body[data-bg="world"]{
      background:
        linear-gradient(rgba(0,0,0,0.14), rgba(0,0,0,0.34)),
        url("image2.jpg") center / cover no-repeat;
    }
    body[data-bg="case"]{
      background:
        linear-gradient(rgba(0,0,0,0.10), rgba(0,0,0,0.26)),
        url("image1.jpg") center / cover no-repeat;
    }

    /* film grain + scanline */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      background:
        radial-gradient(circle at 50% 35%,
          rgba(0,0,0,0.00) 55%,
          rgba(0,0,0,0.55) 100%
        ),
        repeating-linear-gradient(
          0deg,
          rgba(255,255,255,0.004),
          rgba(255,255,255,0.004) 1px,
          transparent 1px,
          transparent 4px
        );
    }

    body[data-bg="title"]::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      background:
        radial-gradient(circle at 20% 25%, rgba(255,255,255,0.06), transparent 50%),
        radial-gradient(circle at 70% 20%, rgba(255,255,255,0.04), transparent 55%),
        radial-gradient(circle at 55% 65%, rgba(255,255,255,0.03), transparent 60%);
      mix-blend-mode: overlay;
      opacity:0.25;
    }

    header, main{ position:relative; z-index:1; }

    header{
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background:rgba(10,12,18,0.22);
      backdrop-filter: blur(8px);
    }

    body[data-bg="title"] header{
      background: rgba(0,0,0,0.18);
      border-bottom:1px solid rgba(255,255,255,0.06);
    }

    header h1{
      margin:0;
      font-size:16px;
      font-weight:900;
      letter-spacing:0.2px;
    }

    header .crumb{
      color:var(--muted);
      font-size:13px;
      margin-top:2px;
      max-width: 80vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .langWrap{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .langLabel{
      color:var(--muted);
      font-size:12px;
    }

    main{ padding:18px; max-width:1100px; margin:0 auto; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .topbar .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }

    .btn{
      background:rgba(0,0,0,0.20);
      border:1px solid rgba(255,255,255,0.10);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
      white-space:nowrap;
      transition: transform .08s ease, border-color .08s ease, background .08s ease, box-shadow .08s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
    }
    .btn:hover{
      border-color: var(--accentSoft);
      background: rgba(0,0,0,0.28);
      transform: translateY(-1px);
    }
    .btn:active{
      transform: translateY(0px) scale(0.99);
    }
    .btn[disabled]{
      opacity:0.55;
      cursor:not-allowed;
      transform:none !important;
    }
    .btnPrimary{
      border-color: rgba(201,162,77,0.45);
      background: rgba(0,0,0,0.28);
      box-shadow: 0 10px 22px rgba(0,0,0,0.25);
    }
    .btnPrimary:hover{
      border-color: rgba(201,162,77,0.65);
      background: rgba(0,0,0,0.36);
      box-shadow: 0 14px 30px rgba(0,0,0,0.35);
    }
    .btn:focus-visible{
      outline: var(--focus);
      outline-offset: 2px;
    }

    .grid{ display:grid; gap:14px; }
    .grid.cols-2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    .grid.cols-3{ grid-template-columns:repeat(3,minmax(0,1fr)); }
    .grid.cols-5{ grid-template-columns:repeat(5,minmax(0,1fr)); }

    @media (max-width:950px){
      .grid.cols-5{ grid-template-columns:repeat(3,minmax(0,1fr)); }
      .grid.cols-2{ grid-template-columns:1fr; }
    }
    @media (max-width:650px){
      .grid.cols-3{ grid-template-columns:1fr; }
      .grid.cols-5{ grid-template-columns:1fr; }
    }

    .card{
      background: linear-gradient(180deg, var(--cardTop), var(--cardBot));
      border:1px solid rgba(255,255,255,0.10);
      border-radius: var(--radius);
      padding:16px;
      cursor:pointer;
      transition: transform .10s ease, border-color .10s ease, box-shadow .10s ease, background .10s ease;
      user-select:none;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
      min-height:96px;
      backdrop-filter: blur(6px);
    }
    .card:hover{
      transform: translateY(-3px);
      border-color: var(--accentSoft);
      box-shadow: var(--shadowHover);
    }
    .card:active{
      transform: translateY(-1px) scale(0.995);
    }
    .card:focus-visible{
      outline: var(--focus);
      outline-offset: 2px;
    }

    .card h2{ margin:0 0 6px 0; font-size:16px; font-weight:900; }
    .card p{ margin:0; color:var(--muted); font-size:13px; line-height:1.35; }

    .pill{
      display:inline-block;
      padding:4px 8px;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
      background: rgba(0,0,0,0.18);
    }

    .badge{
      position:absolute;
      top:12px;
      right:12px;
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      color:var(--muted);
      background:rgba(0,0,0,0.20);
      backdrop-filter: blur(6px);
    }
    .badge.closed{ border-color:rgba(255,204,102,0.35); color:var(--warn); }
    .badge.active{ border-color:rgba(102,209,143,0.35); color:var(--good); }

    .card[data-status="closed"]{
      opacity:0.68;
      filter:saturate(0.65);
      cursor:not-allowed;
    }
    .card[data-status="closed"]:hover{
      transform:none;
      border-color:rgba(255,255,255,0.10);
      box-shadow: var(--shadow);
    }
    .card[data-status="closed"]::after{
      content:"LOCKED";
      position:absolute;
      top:52%;
      left:50%;
      transform:translate(-50%,-50%) rotate(-12deg);
      padding:8px 16px;
      border:1px solid rgba(255,204,102,0.40);
      color:rgba(255,204,102,0.90);
      background:rgba(0,0,0,0.30);
      border-radius:999px;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      pointer-events:none;
    }

    .panel{
      background: linear-gradient(180deg, var(--panelTop), var(--panelBot));
      border:1px solid rgba(255,255,255,0.10);
      border-radius: var(--radius);
      overflow:hidden;
      backdrop-filter: blur(6px);
      box-shadow: var(--shadow);
    }
    .panel .ph{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      background:rgba(0,0,0,0.22);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .panel .ph h3{ margin:0; font-size:14px; font-weight:900; }
    .panel .content{ padding:12px; }

    .caseHeader{
      display:grid;
      grid-template-columns: 1.25fr 1fr;
      gap:14px;
      margin-bottom:14px;
    }
    @media (max-width:900px){ .caseHeader{ grid-template-columns:1fr; } }

    .stamp{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:10px;
      border:1px dashed rgba(201,162,77,0.55);
      color:rgba(201,162,77,0.95);
      background:rgba(0,0,0,0.14);
      font-weight:900;
      letter-spacing:1.4px;
      text-transform:uppercase;
      font-size:12px;
    }

    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px 12px;
      font-size:13px;
      line-height:1.35;
    }
    .kv .k{ color:var(--muted); }
    .kv .v{ color:var(--text); }

    .split{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:14px;
    }
    @media (max-width:900px){ .split{ grid-template-columns:1fr; } }

    .list{ display:flex; flex-direction:column; gap:10px; }

    .doc{
      border:1px solid rgba(255,255,255,0.10);
      border-radius:12px;
      padding:10px;
      cursor:pointer;
      background:rgba(0,0,0,0.16);
      transition: transform .08s ease, border-color .08s ease, background .08s ease, box-shadow .08s ease;
      position:relative;
      user-select:none;
    }
    .doc:hover{
      transform: translateY(-1px);
      border-color: var(--accentSoft);
      background: rgba(0,0,0,0.22);
    }
    .doc:active{ transform: translateY(0px) scale(0.995); }
    .doc.active{
      border-color: var(--accentSoft);
      box-shadow: 0 10px 22px rgba(0,0,0,0.35);
    }
    .doc:focus-visible{
      outline: var(--focus);
      outline-offset: 2px;
    }

    .docRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .doc .title{ font-weight:900; font-size:13px; margin-bottom:4px; }
    .doc .meta{ color:var(--muted); font-size:12px; }

    .unreadDot{
      width:9px;
      height:9px;
      border-radius:999px;
      background: rgba(201,162,77,0.95);
      box-shadow: 0 0 0 3px rgba(201,162,77,0.12);
      display:none;
      flex-shrink:0;
      margin-top:4px;
    }
    .doc.unread .unreadDot{ display:inline-block; }

    .viewerBody{
      position:relative;
      transition: opacity .14s ease, filter .14s ease;
      min-height: 220px;
    }
    .viewerBody.loading{
      opacity:0.06;
      filter: blur(2px);
    }

    .imgWrap{
      border:1px solid rgba(0,0,0,0.18);
      border-radius:10px;
      background: var(--paper);
      padding:12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.35);
    }
    .imgWrap img{
      width:100%;
      height:auto;
      display:block;
      border-radius:6px;
      outline:1px solid rgba(0,0,0,0.12);
      background:#fff;
    }

    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
      word-break: break-word;
    }

    .viewStamp{
      position:absolute;
      top:10px;
      right:10px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(201,162,77,0.55);
      background: rgba(0,0,0,0.28);
      color: rgba(201,162,77,0.95);
      font-weight:900;
      letter-spacing:1.2px;
      text-transform:uppercase;
      font-size:12px;
      opacity:0;
      transform: translateY(-4px);
      pointer-events:none;
    }
    .viewStamp.show{
      opacity:1;
      transform: translateY(0px);
      transition: opacity .14s ease, transform .14s ease;
    }

    /* Title screen */
    .titleWrap{
      min-height: calc(100vh - 64px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px 0 40px;
    }
    @media (max-width: 650px){
      .titleWrap{ min-height: calc(100vh - 92px); }
    }

    .titlePanel{
      width:min(720px, 100%);
      background: linear-gradient(180deg, rgba(26,28,40,0.80), rgba(12,12,18,0.80));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      box-shadow: 0 18px 48px rgba(0,0,0,0.60);
      backdrop-filter: blur(8px);
      overflow:hidden;
    }
    .titlePanel .content{ padding:16px; text-align:center; }

    .titleBig{
      margin:0;
      font-size:40px;
      letter-spacing:0.2px;
      font-weight:950;
      line-height:1.1;
    }
    .titleSub{
      margin:10px auto 0;
      color:var(--muted);
      font-size:14px;
      line-height:1.45;
      max-width: 40ch;
    }
    .titleBtns{
      margin:18px auto 0;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      max-width: 340px;
    }
    .titleBtns .btn{
      width:100%;
      padding:12px 14px;
      font-size:15px;
    }
    .titleFoot{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      text-align:center;
    }

    /* Call module */
    .callBox{
      margin-top:10px;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:12px;
      background: rgba(0,0,0,0.14);
      padding:10px;
    }
    .callTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .callTitle{
      font-weight:950;
      letter-spacing:0.6px;
      text-transform:uppercase;
      font-size:12px;
      color: rgba(201,162,77,0.95);
    }
    .callStatus{
      color: var(--muted);
      font-size:12px;
    }
    .callControls{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .callProgressWrap{
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .callBar{
      height:8px;
      flex:1;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      overflow:hidden;
    }
    .callFill{
      height:100%;
      width:0%;
      background: rgba(201,162,77,0.65);
    }
    .callTime{
      font-size:12px;
      color: var(--muted);
      min-width: 96px;
      text-align:right;
    }

    /* Briefing video */
    .briefVid{
      margin-top:10px;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:12px;
      overflow:hidden;
      background: rgba(0,0,0,0.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
    }
    .briefVidInner{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 9;
      background: rgba(0,0,0,0.28);
    }
    .briefVidInner video{
      width:100%;
      height:100%;
      display:block;
      object-fit: cover;
    }

    /* Compound interrogation package video */
    .compoundVideo{
      margin-top:12px;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:12px;
      overflow:hidden;
      background: rgba(0,0,0,0.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
    }
    .compoundVideoInner{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 9;
      background: rgba(0,0,0,0.28);
    }
    .compoundVideoInner video{
      width:100%;
      height:100%;
      display:block;
      object-fit: cover;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.78);
      border:1px solid rgba(255,255,255,0.12);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      z-index:9999;
      opacity:0;
      pointer-events:none;
      transition:opacity .12s ease;
      max-width:min(680px, calc(100% - 24px));
      backdrop-filter: blur(8px);
    }
    .toast.show{ opacity:1; }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      z-index:9998;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      background:rgba(0,0,0,0.58);
      backdrop-filter: blur(6px);
    }
    .modal.show{ display:flex; }
    .modalPanel{
      width:min(560px, 100%);
      background: linear-gradient(180deg, rgba(26,28,40,0.92), rgba(12,12,18,0.92));
      border:1px solid rgba(255,255,255,0.12);
      border-radius:16px;
      box-shadow: 0 18px 48px rgba(0,0,0,0.65);
      overflow:hidden;
    }
    .modalPanel .ph{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.22);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .modalPanel .content{ padding:14px; }
    .modalTitle{
      margin:0;
      font-size:14px;
      font-weight:950;
      letter-spacing:0.2px;
    }
    .modalText{
      margin:8px 0 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }
    .modalBtns{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* Portrait cards (for interrogation rooms) */
    .portraitImg{
      width:100%;
      height:auto;
      display:block;
      border-radius:12px;
      outline:1px solid rgba(255,255,255,0.08);
      margin-bottom:10px;
      background:#111;
    }
    .portraitMeta{
      color:var(--muted);
      font-size:12px;
      margin-top:8px;
      line-height:1.35;
    }
    .portraitMeta b{
      color: var(--text);
      font-weight:900;
    }
    .portraitMeta .row{
      display:flex;
      gap:8px;
      align-items:baseline;
      justify-content:space-between;
    }
    .portraitMeta .k{
      color: var(--muted);
      font-size:12px;
      flex: 0 0 auto;
    }
    .portraitMeta .v{
      color: var(--text);
      font-size:12px;
      text-align:right;
      flex: 1 1 auto;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* RTL */
    body[dir="rtl"]{ direction: rtl; }
    body[dir="rtl"] .topbar .left{ flex-direction: row-reverse; }
    body[dir="rtl"] .badge{ right:auto; left:12px; }
    body[dir="rtl"] .docRow{ flex-direction: row-reverse; }
    body[dir="rtl"] .kv{ grid-template-columns: 1fr 120px; }
    body[dir="rtl"] .kv .k{ text-align:right; }
    body[dir="rtl"] .titleFoot{ flex-direction: row-reverse; }
    body[dir="rtl"] .callProgressWrap{ flex-direction: row-reverse; }
    body[dir="rtl"] .callTime{ text-align:left; }
    body[dir="rtl"] .viewStamp{ right:auto; left:10px; }
    body[dir="rtl"] .modalBtns{ flex-direction: row-reverse; justify-content:flex-start; }
    body[dir="rtl"] .portraitMeta .v{ text-align:left; }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; }
    }
  </style>
</head>

<body data-bg="title" dir="ltr">
  <header>
    <div class="headerLeft">
      <div>
        <h1 id="titleText">Detective Demo</h1>
        <div class="crumb" id="crumb">Entry</div>
      </div>
    </div>

    <div class="langWrap">
      <div class="langLabel" id="langLabel">Language</div>
      <button class="btn" id="langBtn" type="button" aria-label="Toggle language">AR</button>
    </div>
  </header>

  <main id="app"></main>

  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <section class="modalPanel" role="document" aria-labelledby="modalTitle">
      <div class="ph">
        <h3 class="modalTitle" id="modalTitle">Start</h3>
        <button class="btn" id="modalCloseBtn" type="button">×</button>
      </div>
      <div class="content">
        <p class="modalText" id="modalText"></p>
        <div class="modalBtns" id="modalBtns"></div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
/* ============================================================================
  SINGLE FILE ENGINE
============================================================================ */

/* ---------- I18N ---------- */
const UI = {
  en: {
    title: "Detective Demo",
    language: "Language",
    pause: "Pause",
    resume: "Resume",
    entry: "Archive Entry",
    entryLine: "Archived case files. Access is logged.",
    home: "Home",
    chooseDifficulty: "Select difficulty",
    review: "Review",
    casesTitle: (d) => `${cap(d)} cases`,
    back: "Back",
    available: "Active file",
    closed: "Locked",
    sealed: "Locked",
    sealedReason: (n) => {
      const reasons = [
        "Court injunction",
        "Evidence audit",
        "Pending transfer",
        "Internal review",
        "Redacted record",
        "Jurisdiction dispute"
      ];
      return `LOCKED: ${reasons[(n - 1) % reasons.length]}`;
    },
    sealedToast: "Locked by order. No access.",
    easy: "Easy",
    medium: "Medium",
    hard: "Hard",
    easyDesc: "Guided entry. Clean chain of custody.",
    mediumDesc: "Partial gaps. Conflicting timing.",
    hardDesc: "Redactions. Misdirection. Unreliable records.",
    caseIntake: "Case intake",
    caseBrief: "Case brief",
    confidential: "Confidential",
    briefing: "Briefing call",
    briefingPending: "Pending",
    briefingInProgress: "In progress",
    briefingLogged: "Briefing logged",
    answer: "Answer call",
    replayBriefing: "Replay briefing",
    override: "Override protocol",
    overrideToast: "Override will be logged.",
    audioError: "Audio error. File missing?",
    enterOffice: "Enter Detective Office",
    briefingRequired: "Briefing required to proceed.",
    detectiveOffice: "Detective Office",
    documents: "Documents",
    viewer: "Viewer",
    emptyForNow: "No attachments on record.",
    selectDoc: "Select a document.",
    officeBtn: "Back",
    openFull: "Open full image",
    missing: "This file is not configured.",
    imageLoadError: "Could not load this image.",
    caseId: "Case ID",
    status: "Status",
    location: "Location",
    opened: "Opened",
    assigned: "Assigned",
    classification: "Classification",
    viewed: "Viewed",
    openFile: "Open file",
    unread: "unread",
    unreadLabel: "Unread",
    total: "total",

    startCase: "Start case",
    startCaseText: (name) => `Choose how to start ${name}.`,
    newGame: "New game",
    oldGame: "Old game",
    resetToast: "Progress reset.",

    play: "Play",
    info: "Info",
    demoNoticeTitle: "Demo notice",
    demoNoticeText: "This is an early demo. One case is available. Content outside that case is inactive and labeled accordingly. The demo focuses on reviewing investigation materials from an office environment. It does not represent final scope, pacing, or content volume.",
    close: "Close",
    caseAvailable: "Case 1 available (Easy)",

    profiles: "profiles",
    witnessRoomHint: "Select a witness to open their file.",
    suspectRoomHint: "Select a suspect to open their file.",
    personFile: "File",
    notReady: "Content not implemented yet.",

    /* profile fields */
    job: "Job",
    age: "Age",
    blood: "Blood",
    nationality: "Nationality",
    relationship: "Relationship",
    years: "years",

    /* compound package */
    packageTitle: "Interrogation package",
    packageMeta: "Document + video",
    watch: "Watch",
    document: "Document"
  },

  ar: {
    title: "تجربة المحقق",
    language: "اللغة",
    pause: "إيقاف",
    resume: "متابعة",
    entry: "بوابة الأرشيف",
    entryLine: "ملفات قضايا مؤرشفة. يتم تسجيل الوصول.",
    home: "الرئيسية",
    chooseDifficulty: "اختر الصعوبة",
    review: "استعراض",
    casesTitle: (d) => `قضايا ${capAr(d)}`,
    back: "رجوع",
    available: "ملف نشط",
    closed: "مقفل",
    sealed: "مقفل",
    sealedReason: (n) => {
      const reasons = [
        "أمر قضائي",
        "تدقيق الأدلة",
        "بانتظار النقل",
        "مراجعة داخلية",
        "سجل محجوب",
        "نزاع اختصاص"
      ];
      return `مقفل: ${reasons[(n - 1) % reasons.length]}`;
    },
    sealedToast: "الملف مقفل بأمر. لا يمكن الوصول.",
    easy: "سهل",
    medium: "متوسط",
    hard: "صعب",
    easyDesc: "دخول موجه وسلسلة حيازة واضحة.",
    mediumDesc: "فجوات جزئية وتوقيت متضارب.",
    hardDesc: "حجب جزئي وتضليل وسجلات غير موثوقة.",
    caseIntake: "استلام القضية",
    caseBrief: "ملخص القضية",
    confidential: "سري",
    briefing: "مكالمة الإحاطة",
    briefingPending: "غير مسجلة",
    briefingInProgress: "جارية",
    briefingLogged: "تم تسجيل الإحاطة",
    answer: "رد على المكالمة",
    replayBriefing: "إعادة الإحاطة",
    override: "تجاوز البروتوكول",
    overrideToast: "سيتم تسجيل التجاوز.",
    audioError: "خطأ صوتي. هل الملف مفقود؟",
    enterOffice: "دخول مكتب المحقق",
    briefingRequired: "يلزم تسجيل الإحاطة للمتابعة.",
    detectiveOffice: "مكتب المحقق",
    documents: "المستندات",
    viewer: "المعاينة",
    emptyForNow: "لا توجد مرفقات في السجل.",
    selectDoc: "اختر مستندا.",
    officeBtn: "رجوع",
    openFull: "فتح الصورة كاملة",
    missing: "هذا الملف غير مفعّل.",
    imageLoadError: "تعذر تحميل الصورة.",
    caseId: "رقم القضية",
    status: "الحالة",
    location: "الموقع",
    opened: "تاريخ الفتح",
    assigned: "المكلف",
    classification: "التصنيف",
    viewed: "تمت المراجعة",
    openFile: "فتح الملف",
    unread: "غير مقروء",
    unreadLabel: "غير مقروء",
    total: "الإجمالي",

    startCase: "بدء القضية",
    startCaseText: (name) => `اختر طريقة البدء في ${name}.`,
    newGame: "لعبة جديدة",
    oldGame: "متابعة سابقة",
    resetToast: "تمت إعادة الضبط.",

    play: "لعب",
    info: "معلومات",
    demoNoticeTitle: "تنبيه النسخة التجريبية",
    demoNoticeText: "هذه نسخة تجريبية مبكرة. تتوفر قضية واحدة فقط. المحتوى خارج تلك القضية غير نشط وموسوم وفقا لذلك. تركز النسخة على مراجعة مواد التحقيق من داخل بيئة مكتب. لا تمثل النطاق أو الإيقاع أو حجم المحتوى النهائي.",
    close: "إغلاق",
    caseAvailable: "القضية 1 متاحة (سهل)",

    profiles: "ملفات",
    witnessRoomHint: "اختر شاهدا لفتح ملفه.",
    suspectRoomHint: "اختر متهما لفتح ملفه.",
    personFile: "ملف",
    notReady: "المحتوى غير جاهز بعد.",

    /* profile fields */
    job: "الوظيفة",
    age: "العمر",
    blood: "فصيلة الدم",
    nationality: "الجنسية",
    relationship: "صلة بالضحية",
    years: "سنة",

    /* compound package */
    packageTitle: "ملف التحقيق",
    packageMeta: "مستند + فيديو",
    watch: "مشاهدة",
    document: "المستند"
  }
};

function cap(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : ""; }
function capAr(d){
  if (d === "easy") return "السهلة";
  if (d === "medium") return "المتوسطة";
  if (d === "hard") return "الصعبة";
  return d || "";
}
function t(key, ...args){
  const v = UI[state.lang][key];
  return (typeof v === "function") ? v(...args) : v;
}
function txt(obj){ return obj && obj[state.lang] ? obj[state.lang] : (obj?.en ?? ""); }
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ---------- STORAGE ---------- */
const SK = {
  lang: "detective_lang",
  readDocs: "detective_read_docs_v1"
};
const loadJSON = (k, fb) => { try{ const r = localStorage.getItem(k); return r ? JSON.parse(r) : fb; }catch{ return fb; } };
const saveJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));
const getBool = (k) => localStorage.getItem(k) === "1";
const setBool = (k, v) => localStorage.setItem(k, v ? "1" : "0");

/* ---------- READ / UNREAD ---------- */
const readState = loadJSON(SK.readDocs, {});
const isRead = (id) => !!readState[id];
function markRead(id){
  if (!id) return;
  readState[id] = true;
  saveJSON(SK.readDocs, readState);
}
function clearReadsByPrefix(prefix){
  let changed = false;
  for (const k of Object.keys(readState)){
    if (k.startsWith(prefix)){
      delete readState[k];
      changed = true;
    }
  }
  if (changed) saveJSON(SK.readDocs, readState);
}

/* ---------- MEDIA MANAGER (BRIEFING VIDEO ONLY) ---------- */
const VOICE = {
  el: null,
  src: null,
  heardKey: null,
  status: "idle",
  duration: 0,
  currentTime: 0,
  onUpdate: null
};

const notifyVoice = () => (typeof VOICE.onUpdate === "function") && VOICE.onUpdate();
const markBriefHeard = () => VOICE.heardKey && setBool(VOICE.heardKey, true);

function ensureVoice(){
  if (VOICE.el) return VOICE.el;

  const v = document.createElement("video");
  v.preload = "metadata";
  v.playsInline = true;
  v.controls = false;
  v.muted = false;

  v.addEventListener("loadedmetadata", () => {
    VOICE.duration = Number.isFinite(v.duration) ? v.duration : 0;
    notifyVoice();
  });

  v.addEventListener("timeupdate", () => {
    VOICE.currentTime = v.currentTime || 0;
    const d = VOICE.duration || 0;
    if (d > 0 && (VOICE.currentTime / d) > 0.92) markBriefHeard();
    notifyVoice();
  });

  v.addEventListener("play", () => { VOICE.status = "playing"; notifyVoice(); });
  v.addEventListener("pause", () => {
    if (VOICE.status !== "ended") VOICE.status = "paused";
    notifyVoice();
  });
  v.addEventListener("ended", () => { VOICE.status = "ended"; markBriefHeard(); notifyVoice(); });
  v.addEventListener("error", () => { VOICE.status = "error"; notifyVoice(); });

  VOICE.el = v;
  return v;
}

function voiceConfigure({ src, heardKey }){
  const v = ensureVoice();
  const changed = VOICE.src !== src;
  VOICE.src = src;
  VOICE.heardKey = heardKey;

  if (changed){
    VOICE.status = "idle";
    VOICE.duration = 0;
    VOICE.currentTime = 0;
    v.src = src || "";
    try{ v.load(); }catch{}
  }

  notifyVoice();
}

async function voicePlayFromStart(){
  const v = ensureVoice();
  try{
    v.currentTime = 0;
    VOICE.currentTime = 0;
    await v.play();
  }catch{
    VOICE.status = "error";
    notifyVoice();
  }
}

function voicePause(){ VOICE.el && VOICE.el.pause(); }

async function voiceResume(){
  const v = ensureVoice();
  try{ await v.play(); }catch{ VOICE.status = "error"; notifyVoice(); }
}

function voiceStop(){
  if (!VOICE.el) return;
  VOICE.el.pause();
  VOICE.el.currentTime = 0;
  VOICE.currentTime = 0;
  VOICE.status = "idle";
  notifyVoice();
}

function formatTime(s){
  const sec = Math.max(0, Math.floor(s || 0));
  const m = Math.floor(sec / 60);
  const r = sec % 60;
  return `${m}:${String(r).padStart(2,"0")}`;
}

/* ---------- APP STATE ---------- */
const state = {
  lang: (localStorage.getItem(SK.lang) === "ar") ? "ar" : "en",
  view: "title",
  difficulty: null,
  caseKey: null,
  sectionId: null,
  personId: null,
  docId: null,
  protocolOverride: false
};

/* ---------- DOM ---------- */
const $ = (id) => document.getElementById(id);
const rootHtml = $("rootHtml");
const app = $("app");
const crumb = $("crumb");
const toastEl = $("toast");
const titleText = $("titleText");
const langLabel = $("langLabel");
const langBtn = $("langBtn");

const modal = $("modal");
const modalTitle = $("modalTitle");
const modalText = $("modalText");
const modalBtns = $("modalBtns");
const modalCloseBtn = $("modalCloseBtn");

function showToast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  window.clearTimeout(showToast._t);
  showToast._t = window.setTimeout(() => toastEl.classList.remove("show"), 1400);
}

function makeClickable(el, onActivate, { disabled = false } = {}){
  if (!el) return;
  if (disabled){
    el.setAttribute("aria-disabled", "true");
    el.removeAttribute("tabindex");
    el.removeAttribute("role");
    return;
  }
  el.setAttribute("tabindex", "0");
  el.setAttribute("role", "button");
  el.addEventListener("click", onActivate);
  el.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " "){
      e.preventDefault();
      onActivate();
    }
  });
}

function renderTopbar(titleRight, subtitle){
  const left = `
    <div class="left">
      ${(state.view === "title") ? "" : `<button class="btn" id="backBtn" type="button">${escapeHtml(t("back"))}</button>`}
      <div style="display:flex;flex-direction:column;gap:2px;min-width:0;">
        <div style="font-weight:900;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
          ${escapeHtml(titleRight)}
        </div>
        ${subtitle ? `<div style="color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(subtitle)}</div>` : ""}
      </div>
    </div>
  `;
  return `<div class="topbar">${left}<div></div></div>`;
}

function setBackgroundForView(){
  const v = state.view;
  if (v === "title") document.body.setAttribute("data-bg", "title");
  else if (v === "difficulty" || v === "cases") document.body.setAttribute("data-bg", "world");
  else document.body.setAttribute("data-bg", "case");
}

function applyLang(){
  const isAr = state.lang === "ar";
  document.body.setAttribute("dir", isAr ? "rtl" : "ltr");
  rootHtml.setAttribute("lang", isAr ? "ar" : "en");
  titleText.textContent = t("title");
  langLabel.textContent = t("language");
  langBtn.textContent = isAr ? "EN" : "AR";
  render();
}

langBtn.addEventListener("click", () => {
  state.lang = (state.lang === "en") ? "ar" : "en";
  localStorage.setItem(SK.lang, state.lang);
  applyLang();
});

/* ---------- MODAL ---------- */
let modalResolve = null;
function openModal({ title, text, buttons }){
  modalTitle.textContent = title;
  modalText.textContent = text;
  modalBtns.innerHTML = buttons.map(b => `
    <button class="btn ${b.primary ? "btnPrimary" : ""}" data-key="${escapeHtml(b.key)}" type="button">
      ${escapeHtml(b.label)}
    </button>
  `).join("");

  modal.classList.add("show");
  modal.setAttribute("aria-hidden", "false");

  modalBtns.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => closeModal(btn.dataset.key));
  });

  return new Promise((resolve) => {
    modalResolve = resolve;
  });
}

function closeModal(result){
  modal.classList.remove("show");
  modal.setAttribute("aria-hidden", "true");
  const r = modalResolve;
  modalResolve = null;
  if (r) r(result);
}

modalCloseBtn.addEventListener("click", () => closeModal("cancel"));
modal.addEventListener("click", (e) => { if (e.target === modal) closeModal("cancel"); });

window.addEventListener("keydown", (e) => {
  if (modal.classList.contains("show") && e.key === "Escape"){
    e.preventDefault();
    closeModal("cancel");
  }
});

/* ---------- NAV ---------- */
function go(view, patch = {}){
  state.view = view;
  if ("difficulty" in patch) state.difficulty = patch.difficulty;
  if ("caseKey" in patch) state.caseKey = patch.caseKey;
  if ("sectionId" in patch) state.sectionId = patch.sectionId;
  if ("personId" in patch) state.personId = patch.personId;
  if ("docId" in patch) state.docId = patch.docId;
  if ("protocolOverride" in patch) state.protocolOverride = patch.protocolOverride;
  render();
}
function goTitle(){ go("title", { difficulty:null, caseKey:null, sectionId:null, personId:null, docId:null, protocolOverride:false }); }
function goDifficulty(){ go("difficulty", { difficulty:null, caseKey:null, sectionId:null, personId:null, docId:null, protocolOverride:false }); }
function goCases(difficulty){ go("cases", { difficulty, caseKey:null, sectionId:null, personId:null, docId:null, protocolOverride:false }); }
function goIntake(caseKey){ go("intake", { caseKey, sectionId:null, personId:null, docId:null, protocolOverride:false }); }
function goOffice(){ go("office", { sectionId:null, personId:null, docId:null }); }
function goSection(sectionId){ go("section", { sectionId, personId:null, docId:null }); }
function goPersonFile(personId){ go("person", { personId, docId:null }); }

function back(){
  const v = state.view;
  if (v === "person")  { go("section", { personId:null, docId:null }); return; }
  if (v === "section") { go("office", { sectionId:null, personId:null, docId:null }); return; }
  if (v === "office")  { go("intake", { sectionId:null, personId:null, docId:null }); return; }
  if (v === "intake")  { go("cases",  { caseKey:null, sectionId:null, personId:null, protocolOverride:false }); return; }























  if (v === "cases")   { go("difficulty", { difficulty:null, caseKey:null, sectionId:null, personId:null }); return; }
  if (v === "difficulty") { goTitle(); return; }
  goTitle();
}
function wireBack(){
  const b = $("backBtn");
  b && b.addEventListener("click", back);
}
window.addEventListener("keydown", (e) => {
  if (modal.classList.contains("show")) return;
  if (e.key === "Escape"){ e.preventDefault(); back(); }
});

/* ---------- GAME INDEX ---------- */
const GAME_INDEX = {
  difficulties: [
    { id: "easy", titleKey: "easy", descKey: "easyDesc" },
    { id: "medium", titleKey: "medium", descKey: "mediumDesc" },
    { id: "hard", titleKey: "hard", descKey: "hardDesc" }
  ],
  casesByDifficulty: {
    easy: Array.from({ length: 10 }, (_, i) => ({
      key: `easy_case_${i+1}`,
      label: { en: `Case ${i+1}`, ar: `القضية ${i+1}` },
      status: (i === 0) ? "active" : "closed",
      sealedN: i + 1,
      packId: (i === 0) ? "easy_case_1" : null
    })),
    medium: Array.from({ length: 10 }, (_, i) => ({
      key: `medium_case_${i+1}`,
      label: { en: `Case ${i+1}`, ar: `القضية ${i+1}` },
      status: "closed",
      sealedN: i + 1,
      packId: null
    })),
    hard: Array.from({ length: 10 }, (_, i) => ({
      key: `hard_case_${i+1}`,
      label: { en: `Case ${i+1}`, ar: `القضية ${i+1}` },
      status: "closed",
      sealedN: i + 1,
      packId: null
    }))
  }
};

const countPackDocs = (pack) => {
  const by = pack?.documents || {};
  let n = 0;
  for (const k of Object.keys(by)){
    const arr = by[k];
    n += Array.isArray(arr) ? arr.length : 0;
  }
  return n;
};
const hasBriefing = (pack) => !!pack?.briefing?.mediaSrc;

/* ---------- CASE PACKS ---------- */
const CASE_PACKS = {
  easy_case_1: {
    meta: {
      caseId: { en: "E-01", ar: "E-01" },
      status: { en: "Active file", ar: "ملف نشط" },
      location: { en: "Old City, 3rd Precinct", ar: "المدينة القديمة، المركز الثالث" },
      opened: { en: "1974-10-18", ar: "1974-10-18" },
      assigned: { en: "Detective (You)", ar: "المحقق (أنت)" },
      classification: { en: "Confidential", ar: "سري" }
    },

    briefing: {
      mediaSrc: "vid.mp4",
      heardStorageKey: "detective_easy_case_1_brief_heard_v1"
    },

    sections: [
      { id: "objectives", title: { en: "Case objectives", ar: "أهداف القضية" } },
      { id: "forensic", title: { en: "Forensic evidence report", ar: "تقرير الادلة الجنائية" } },
      { id: "witness_room", title: { en: "Witness interrogation room", ar: "غرفة التحقيق مع الشهود" } },
      { id: "suspect_room", title: { en: "Suspect interrogation room", ar: "غرفة التحقيق مع المتهمين" } },
      { id: "additional", title: { en: "Additional evidence", ar: "أدلة أضافية" } }
    ],

    people: {
      witnesses: [
        {
          id: "w_ahmed",
          name: { en: "Ahmed", ar: "أحمد" },
          image: "person1.jpg",
          profile: {
            job: { en: "Security", ar: "حارس أمن" },
            age: 36,
            blood: "O+",
            nationality: { en: "Sudanese", ar: "سوداني" },
            relationship: { en: "Employee", ar: "موظف" }
          },
          package: {
            docId: "ec1_pkg_w_ahmed_doc",
            vidId: "ec1_pkg_w_ahmed_vid",
            docTitle: { en: "Statement document", ar: "مستند الإفادة" },
            docMeta: { en: "Scan", ar: "مسح ضوئي" },
            docUrl: "doc1.jpg",
            vidTitle: { en: "Interrogation video", ar: "فيديو التحقيق" },
            vidMeta: { en: "Recorded", ar: "مسجل" },
            vidSrc: "vid1.mp4"
          }
        },
        {
          id: "w_osama",
          name: { en: "Osama", ar: "أسامة" },
          image: "person2.jpg",
          profile: {
            job: { en: "Teacher", ar: "معلم" },
            age: 29,
            blood: "B+",
            nationality: { en: "Kuwaiti", ar: "كويتي" },
            relationship: { en: "Brother", ar: "أخو المقتول" }
          },
          package: {
            docId: "ec1_pkg_w_osama_doc",
            vidId: "ec1_pkg_w_osama_vid",
            docTitle: { en: "Statement document", ar: "مستند الإفادة" },
            docMeta: { en: "Scan", ar: "مسح ضوئي" },
            docUrl: "doc2.jpg",
            vidTitle: { en: "Interrogation video", ar: "فيديو التحقيق" },
            vidMeta: { en: "Recorded", ar: "مسجل" },
            vidSrc: "vid2.mp4"
          }
        },
        {
          id: "w_aseel",
          name: { en: "Aseel", ar: "أسيل" },
          image: "person3.jpg",
          profile: {
            job: { en: "Nurse", ar: "ممرضة" },
            age: 27,
            blood: "O+",
            nationality: { en: "Kuwaiti", ar: "كويتية" },
            relationship: { en: "Wife", ar: "زوجة المقتول" }
          },
          package: {
            docId: "ec1_pkg_w_aseel_doc",
            vidId: "ec1_pkg_w_aseel_vid",
            docTitle: { en: "Statement document", ar: "مستند الإفادة" },
            docMeta: { en: "Scan", ar: "مسح ضوئي" },
            docUrl: "doc3.jpg",
            vidTitle: { en: "Interrogation video", ar: "فيديو التحقيق" },
            vidMeta: { en: "Recorded", ar: "مسجل" },
            vidSrc: "vid3.mp4"
          }
        }
      ],
      suspects: [
        {
          id: "s_khalid",
          name: { en: "Khalid", ar: "خالد" },
          image: "person4.jpg",
          profile: {
            job: { en: "Lawyer", ar: "محامي" },
            age: 31,
            blood: "B+",
            nationality: { en: "Kuwaiti", ar: "كويتي" },
            relationship: { en: "Rival lawyer", ar: "محامي منافس" }
          },
          package: {
            docId: "ec1_pkg_s_khalid_doc",
            vidId: "ec1_pkg_s_khalid_vid",
            docTitle: { en: "Statement document", ar: "مستند الإفادة" },
            docMeta: { en: "Scan", ar: "مسح ضوئي" },
            docUrl: "doc4.jpg",
            vidTitle: { en: "Interrogation video", ar: "فيديو التحقيق" },
            vidMeta: { en: "Recorded", ar: "مسجل" },
            vidSrc: "vid4.mp4"
          }
        },
        {
          id: "s_zaid",
          name: { en: "Zaid", ar: "زيد" },
          image: "person5.jpg",
          profile: {
            job: { en: "Unemployed", ar: "عاطل" },
            age: 48,
            blood: "O+",
            nationality: { en: "Kuwaiti", ar: "كويتي" },
            relationship: { en: "", ar: "" }
          },
          package: {
            docId: "ec1_pkg_s_zaid_doc",
            vidId: "ec1_pkg_s_zaid_vid",
            docTitle: { en: "Statement document", ar: "مستند الإفادة" },
            docMeta: { en: "Scan", ar: "مسح ضوئي" },
            docUrl: "doc5.jpg",
            vidTitle: { en: "Interrogation video", ar: "فيديو التحقيق" },
            vidMeta: { en: "Recorded", ar: "مسجل" },
            vidSrc: "vid5.mp4"
          }
        },
        {
          id: "s_ahmed2",
          name: { en: "Ahmed", ar: "أحمد" },
          image: "person1.jpg",
          profile: {
            job: { en: "Security", ar: "حارس أمن" },
            age: 36,
            blood: "O+",
            nationality: { en: "Sudanese", ar: "سوداني" },
            relationship: { en: "Employee", ar: "موظف" }
          },
          package: {
            docId: "ec1_pkg_s_ahmed2_doc",
            vidId: "ec1_pkg_s_ahmed2_vid",
            docTitle: { en: "Statement document", ar: "مستند الإفادة" },
            docMeta: { en: "Scan", ar: "مسح ضوئي" },
            docUrl: "doc6.jpg",
            vidTitle: { en: "Interrogation video", ar: "فيديو التحقيق" },
            vidMeta: { en: "Recorded", ar: "مسجل" },
            vidSrc: "vid6.mp4"
          }
        }
      ]
    },

    documents: {
      objectives: [
        {
          id: "ec1_obj_1",
          title: { en: "Objectives", ar: "الأهداف" },
          meta:  { en: "Draft", ar: "مسودة" },
          type: "text",
          body: {
            en:
`1) Identify victim and last known movements.
2) Establish timeline from witness accounts.
3) Reconcile discrepancies between scene notes and photographs.
4) Determine likely entry and exit routes.`,
            ar:
`1) تحديد هوية الضحية وآخر تحركاتها.
2) بناء خط زمني من إفادات الشهود.
3) مطابقة التعارضات بين ملاحظات الموقع والصور.
4) تحديد مسارات الدخول والخروج المرجحة.`
          }
        }
      ],

      forensic: [
        { id: "ec1_for_1", title: { en: "Death report", ar: "تقرير الوفاة" }, type: "image", meta: { en: "Evidence", ar: "دليل" }, url: "evidence1.jpg" },
        { id: "ec1_for_2", title: { en: "Weapon report and photo", ar: "تقرير السلاح وصورة عنه" }, type: "image", meta: { en: "Evidence", ar: "دليل" }, url: "evidence2.jpg" },
        { id: "ec1_for_3", title: { en: "Fingerprints report", ar: "تقرير البصمات" }, type: "image", meta: { en: "Evidence", ar: "دليل" }, url: "evidence3.jpg" }
      ],

      additional: [
        { id: "ec1_add_4",  title: { en: "Left glove", ar: "قفاز يسار" }, type: "image", meta: { en: "Evidence", ar: "دليل" }, url: "evidence4.jpg" },
        { id: "ec1_add_5",  title: { en: "Ahmed call log", ar: "سجل مكالمات احمد" }, type: "image", meta: { en: "Evidence", ar: "دليل" }, url: "evidence5.jpg" },
        { id: "ec1_add_6",  title: { en: "Victim call log", ar: "سجل مكالمات المقتول" }, type: "image", meta: { en: "Evidence", ar: "دليل" }, url: "evidence6.jpg" },
        { id: "ec1_add_7",  title: { en: "Chat screenshot: Ahmed and rival", ar: "صورة محادثة بين أحمد والمنافس" }, type: "image", meta: { en: "Evidence", ar: "دليل" }, url: "evidence7.jpg" },
        { id: "ec1_add_8",  title: { en: "Prior case against killer's brother", ar: "قضية سابقة ضذ اخو القاتل" }, type: "image", meta: { en: "Evidence", ar: "دليل" }, url: "evidence8.jpg" },
        { id: "ec1_add_9",  title: { en: "Rival criminal record", ar: "الصحيفة الجنائية لمنافس" }, type: "image", meta: { en: "Evidence", ar: "دليل" }, url: "evidence9.jpg" },
        { id: "ec1_add_10", title: { en: "Killer criminal record", ar: "الصحيفة الجنائية للقاتل" }, type: "image", meta: { en: "Evidence", ar: "دليل" }, url: "evidence10.jpg" }
      ]
    }
  }
};

/* ---------- HELPERS ---------- */
function isInterrogationSection(id){
  return id === "witness_room" || id === "suspect_room";
}
function getCaseItem(difficulty, caseKey){
  const list = GAME_INDEX.casesByDifficulty[difficulty] || [];
  return list.find(c => c.key === caseKey) || null;
}
function getPackForCaseKey(difficulty, caseKey){
  const item = getCaseItem(difficulty, caseKey);
  if (!item || !item.packId) return null;
  return CASE_PACKS[item.packId] || null;
}
function diffName(id){
  const d = GAME_INDEX.difficulties.find(x => x.id === id);
  return d ? t(d.titleKey) : "";
}
function findPerson(pack, personId){
  if (!pack || !personId) return null;
  const all = [...(pack.people?.witnesses || []), ...(pack.people?.suspects || [])];
  return all.find(p => p.id === personId) || null;
}
function peopleForSection(pack, sectionId){
  if (!pack) return [];
  if (sectionId === "witness_room") return pack.people?.witnesses || [];
  if (sectionId === "suspect_room") return pack.people?.suspects || [];
  return [];
}

function setCrumb(){
  if (state.view === "title") { crumb.textContent = t("entry"); return; }
  if (state.view === "difficulty") { crumb.textContent = t("home"); return; }

  const dName = diffName(state.difficulty);
  if (state.view === "cases") { crumb.textContent = `${t("home")} / ${dName}`; return; }

  const caseItem = getCaseItem(state.difficulty, state.caseKey);
  const caseLabel = caseItem ? txt(caseItem.label) : "";

  if (state.view === "intake") { crumb.textContent = `${t("home")} / ${dName} / ${caseLabel} / ${t("caseIntake")}`; return; }
  if (state.view === "office") { crumb.textContent = `${t("home")} / ${dName} / ${caseLabel} / ${t("detectiveOffice")}`; return; }

  if (state.view === "section"){
    const pack = getPackForCaseKey(state.difficulty, state.caseKey);
    const sec = pack?.sections?.find(s => s.id === state.sectionId);
    const secTitle = sec ? txt(sec.title) : "";
    crumb.textContent = `${t("home")} / ${dName} / ${caseLabel} / ${t("detectiveOffice")} / ${secTitle}`;
    return;
  }

  if (state.view === "person"){
    const pack = getPackForCaseKey(state.difficulty, state.caseKey);
    const sec = pack?.sections?.find(s => s.id === state.sectionId);
    const secTitle = sec ? txt(sec.title) : "";
    const p = findPerson(pack, state.personId);
    const pName = p ? txt(p.name) : "";
    crumb.textContent = `${t("home")} / ${dName} / ${caseLabel} / ${t("detectiveOffice")} / ${secTitle} / ${pName}`;
    return;
  }

  crumb.textContent = t("home");
}

function flashViewerStamp(label){
  const stamp = $("viewStamp");
  if (!stamp) return;
  stamp.textContent = label;
  stamp.classList.add("show");
  window.clearTimeout(flashViewerStamp._t);
  flashViewerStamp._t = window.setTimeout(() => stamp.classList.remove("show"), 900);
}

function protocolAllowsOffice(pack){
  const heardKey = pack?.briefing?.heardStorageKey;
  const heard = heardKey ? getBool(heardKey) : false;
  return heard || state.protocolOverride;
}

/* ---------- NEW/OLD GAME FLOW ---------- */
function caseReadPrefix(packId){
  if (packId === "easy_case_1") return "ec1_";
  return packId + "_";
}
function resetCaseProgress(packId){
  const pack = CASE_PACKS[packId];
  if (!pack) return;

  clearReadsByPrefix(caseReadPrefix(packId));

  const hk = pack.briefing?.heardStorageKey;
  if (hk) setBool(hk, false);

  showToast(t("resetToast"));
}

async function promptStartCase(caseItem){
  const packId = caseItem.packId;
  const label = txt(caseItem.label);

  const choice = await openModal({
    title: t("startCase"),
    text: t("startCaseText", label),
    buttons: [
      { key: "new", label: t("newGame"), primary: true },
      { key: "old", label: t("oldGame"), primary: false }
    ]
  });

  if (choice === "cancel") return;

  if (choice === "new") resetCaseProgress(packId);
  goIntake(caseItem.key);
}

/* ---------- RENDERERS ---------- */
function renderTitle(){
  app.innerHTML = `
    <div class="titleWrap">
      <section class="titlePanel">
        <div class="content">
          <h2 class="titleBig">${escapeHtml(t("title"))}</h2>
          <p class="titleSub">${escapeHtml(t("entryLine"))}</p>

          <div class="titleBtns">
            <button class="btn btnPrimary" id="playBtn" type="button">${escapeHtml(t("play"))}</button>
            <button class="btn" id="infoBtn" type="button">${escapeHtml(t("info"))}</button>
          </div>

          <div class="titleFoot">
            <span class="mono" style="color:var(--muted);font-size:12px;">${escapeHtml(t("caseAvailable"))}</span>
            <span></span>
          </div>
        </div>
      </section>
    </div>
  `;

  $("playBtn")?.addEventListener("click", goDifficulty);

  $("infoBtn")?.addEventListener("click", async () => {
    await openModal({
      title: t("demoNoticeTitle"),
      text: t("demoNoticeText"),
      buttons: [{ key: "ok", label: t("close"), primary: true }]
    });
  });
}

function renderDifficulty(){
  app.innerHTML = `
    ${renderTopbar(t("chooseDifficulty"))}
    <div class="grid cols-3">
      ${GAME_INDEX.difficulties.map(d => `
        <div class="card" data-diff="${d.id}">
          <h2>${escapeHtml(t(d.titleKey))}</h2>
          <p>${escapeHtml(t(d.descKey))}</p>
          <div class="pill">${escapeHtml(t("review"))}</div>
        </div>
      `).join("")}
    </div>
  `;
  wireBack();
  app.querySelectorAll(".card").forEach(el => makeClickable(el, () => goCases(el.dataset.diff)));
}

function renderCases(){
  const list = GAME_INDEX.casesByDifficulty[state.difficulty] || [];
  app.innerHTML = `
    ${renderTopbar(t("casesTitle", state.difficulty))}
    <div class="grid cols-5">
      ${list.map(c => {
        const isActive = c.status === "active";
        const badgeClass = isActive ? "active" : "closed";
        const badgeText = isActive ? t("available") : t("closed");

        const pack = (c.packId && CASE_PACKS[c.packId]) ? CASE_PACKS[c.packId] : null;
        const docsN = pack ? countPackDocs(pack) : 0;
        const callsN = (pack && hasBriefing(pack)) ? 1 : 0;

        const detail = isActive
          ? `${docsN} documents, ${callsN} call`
          : t("sealedReason", c.sealedN);

        const pillText = isActive ? t("openFile") : t("sealed");

        return `
          <div class="card" data-case="${c.key}" data-status="${c.status}" aria-label="${escapeHtml(txt(c.label))}">
            <div class="badge ${badgeClass}">${escapeHtml(badgeText)}</div>
            <h2>${escapeHtml(txt(c.label))}</h2>
            <p>${escapeHtml(detail)}</p>
            <div class="pill">${escapeHtml(pillText)}</div>
          </div>
        `;
      }).join("")}
    </div>
  `;
  wireBack();

  app.querySelectorAll(".card").forEach(el => {
    const disabled = el.dataset.status !== "active";
    makeClickable(el, async () => {
      if (disabled) { showToast(t("sealedToast")); return; }
      const caseItem = getCaseItem(state.difficulty, el.dataset.case);
      if (!caseItem) return;
      await promptStartCase(caseItem);
    }, { disabled });
  });
}

function renderIntake(){
  const pack = getPackForCaseKey(state.difficulty, state.caseKey);
  if (!pack){
    app.innerHTML = `
      ${renderTopbar(t("caseIntake"))}
      <div class="panel">
        <div class="ph"><h3>${escapeHtml(t("caseIntake"))}</h3></div>
        <div class="content" style="color:var(--muted);font-size:13px;line-height:1.4;">
          ${escapeHtml(t("missing"))}
        </div>
      </div>
    `;
    wireBack();
    return;
  }

  const heardKey = pack.briefing?.heardStorageKey;
  const heard = heardKey ? getBool(heardKey) : false;
  const allowed = protocolAllowsOffice(pack);

  voiceConfigure({ src: pack.briefing?.mediaSrc || null, heardKey: heardKey || null });

  app.innerHTML = `
    ${renderTopbar(t("caseIntake"))}

    <div class="caseHeader">
      <section class="panel">
        <div class="ph">
          <h3>${escapeHtml(t("caseBrief"))}</h3>
          <span class="stamp"><span class="mono">${escapeHtml(t("confidential"))}</span></span>
        </div>







































        <div class="content">
          <div class="kv">
            <div class="k">${escapeHtml(t("caseId"))}</div><div class="v mono">${escapeHtml(txt(pack.meta.caseId))}</div>
            <div class="k">${escapeHtml(t("status"))}</div><div class="v">${escapeHtml(txt(pack.meta.status))}</div>
            <div class="k">${escapeHtml(t("location"))}</div><div class="v">${escapeHtml(txt(pack.meta.location))}</div>
            <div class="k">${escapeHtml(t("opened"))}</div><div class="v mono">${escapeHtml(txt(pack.meta.opened))}</div>
            <div class="k">${escapeHtml(t("assigned"))}</div><div class="v">${escapeHtml(txt(pack.meta.assigned))}</div>
            <div class="k">${escapeHtml(t("classification"))}</div><div class="v">${escapeHtml(txt(pack.meta.classification))}</div>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="ph">
          <h3>${escapeHtml(t("briefing"))}</h3>
          <span style="color:var(--muted);font-size:12px;" class="mono">${escapeHtml(txt(pack.meta.caseId))}</span>
        </div>

        <div class="content">
          <div class="callBox">
            <div class="callTop">
              <div>
                <div class="callTitle">${escapeHtml(t("briefing"))}</div>
                <div class="callStatus" id="callStatus">${escapeHtml(heard ? t("briefingLogged") : t("briefingPending"))}</div>
              </div>
              <div class="mono" style="color:var(--muted);font-size:12px;" id="callSideLabel">
                ${escapeHtml(heard ? t("briefingLogged") : t("briefingPending"))}
              </div>
            </div>

            <div class="briefVid">
              <div class="briefVidInner" id="briefVidMount"></div>
            </div>

            <div class="callControls">
              <button class="btn btnPrimary" id="callBtn" type="button">
                ${escapeHtml(heard ? t("replayBriefing") : t("answer"))}
              </button>

              <button class="btn" id="pauseBtn" type="button" disabled>
                ${escapeHtml(t("pause"))}
              </button>

              ${allowed ? "" : `<button class="btn" id="overrideBtn" type="button">${escapeHtml(t("override"))}</button>`}
            </div>

            <div class="callProgressWrap">
              <div class="callBar"><div class="callFill" id="callFill"></div></div>
              <div class="callTime mono" id="callTime">0:00 / 0:00</div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;">
            <button class="btn btnPrimary" id="enterOfficeBtn" type="button" ${allowed ? "" : "disabled"}>${escapeHtml(t("enterOffice"))}</button>
          </div>

          ${allowed ? "" : `<div style="margin-top:8px;color:var(--muted);font-size:12px;">${escapeHtml(t("briefingRequired"))}</div>`}
        </div>
      </section>
    </div>
  `;

  wireBack();

  const callBtn = $("callBtn");
  const pauseBtn = $("pauseBtn");
  const overrideBtn = $("overrideBtn");
  const statusEl = $("callStatus");
  const sideLabelEl = $("callSideLabel");
  const fillEl = $("callFill");
  const timeEl = $("callTime");
  const enterOfficeBtn = $("enterOfficeBtn");

  callBtn.addEventListener("click", async () => { await voicePlayFromStart(); });

  pauseBtn.addEventListener("click", async () => {
    if (VOICE.status === "playing") voicePause();
    else if (VOICE.status === "paused") await voiceResume();
  });

  overrideBtn && overrideBtn.addEventListener("click", () => {
    state.protocolOverride = true;
    showToast(t("overrideToast"));
    render();
  });

  enterOfficeBtn.addEventListener("click", () => {
    if (!protocolAllowsOffice(pack)){
      showToast(t("briefingRequired"));
      return;
    }
    goOffice();
  });

  VOICE.onUpdate = () => {
    const heardNow = heardKey ? getBool(heardKey) : false;

    let label = heardNow ? t("briefingLogged") : t("briefingPending");
    if (VOICE.status === "playing") label = t("briefingInProgress");
    if (VOICE.status === "error") label = t("audioError");

    statusEl.textContent = label;
    sideLabelEl.textContent = label;
    callBtn.textContent = heardNow ? t("replayBriefing") : t("answer");

    const d = VOICE.duration || (VOICE.el ? VOICE.el.duration : 0) || 0;
    const c = VOICE.currentTime || (VOICE.el ? VOICE.el.currentTime : 0) || 0 || 0;
    const pct = d > 0 ? Math.min(100, Math.max(0, (c / d) * 100)) : 0;

    fillEl.style.width = pct.toFixed(1) + "%";
    timeEl.textContent = `${formatTime(c)} / ${formatTime(d)}`;

    if (VOICE.status === "playing"){
      pauseBtn.disabled = false;
      pauseBtn.textContent = t("pause");
    } else if (VOICE.status === "paused"){
      pauseBtn.disabled = false;
      pauseBtn.textContent = t("resume");
    } else {
      pauseBtn.disabled = true;
      pauseBtn.textContent = t("pause");
    }

    enterOfficeBtn.disabled = !protocolAllowsOffice(pack);
  };

  // Mount the video element into the intake UI
  const mount = $("briefVidMount");
  if (mount){
    const v = ensureVoice();
    v.style.width = "100%";
    v.style.height = "100%";
    v.playsInline = true;

    if (!mount.contains(v)){
      mount.innerHTML = "";
      mount.appendChild(v);
    }
  }

  ensureVoice();
  notifyVoice();
}

/* ---------- OFFICE + SECTIONS ---------- */
function renderOffice(){
  const pack = getPackForCaseKey(state.difficulty, state.caseKey);
  if (!pack){
    app.innerHTML = `
      ${renderTopbar(t("detectiveOffice"))}
      <div class="panel">
        <div class="ph"><h3>${escapeHtml(t("detectiveOffice"))}</h3></div>
        <div class="content" style="color:var(--muted);font-size:13px;line-height:1.4;">
          ${escapeHtml(t("missing"))}
        </div>
      </div>
    `;
    wireBack();
    return;
  }

  app.innerHTML = `
    ${renderTopbar(t("detectiveOffice"))}
    <div class="grid cols-5" id="sectionGrid">
      ${pack.sections.map(s => {
        let pill = "";

        if (isInterrogationSection(s.id)){
          const ppl = peopleForSection(pack, s.id);
          pill = `${ppl.length} · ${t("profiles")}`;
        } else {
          const total = (pack?.documents?.[s.id] || []).length;
          const unread = (pack?.documents?.[s.id] || []).reduce((n,d) => n + (!isRead(d.id) ? 1 : 0), 0);
          pill = `${total} · ${unread} ${t("unread")}`;
        }

        return `
          <div class="card" data-section="${s.id}" data-status="active">
            <h2>${escapeHtml(txt(s.title))}</h2>
            <p>${escapeHtml(pill)}</p>
          </div>
        `;
      }).join("")}
    </div>
  `;
  wireBack();

  $("sectionGrid").querySelectorAll(".card").forEach(el => {
    makeClickable(el, () => goSection(el.dataset.section));
  });
}

function renderProfileMeta(p){
  const prof = p?.profile || null;
  if (!prof) return "";

  const rows = [
    [t("job"), txt(prof.job)],
    [t("age"), `${prof.age ?? ""} ${t("years")}`.trim()],
    [t("blood"), prof.blood ?? ""],
    [t("nationality"), txt(prof.nationality)],
    [t("relationship"), txt(prof.relationship)]
  ].filter(([_, v]) => String(v || "").trim().length > 0);

  return `
    <div class="portraitMeta mono">
      ${rows.map(([k,v]) => `
        <div class="row">
          <span class="k">${escapeHtml(k)}</span>
          <span class="v">${escapeHtml(v)}</span>
        </div>
      `).join("")}
    </div>
  `;
}

function renderInterrogationRoom(pack, sec){
  const list = peopleForSection(pack, sec.id);
  const hint = (sec.id === "witness_room") ? t("witnessRoomHint") : t("suspectRoomHint");

  app.innerHTML = `
    ${renderTopbar(txt(sec.title), hint)}
    <div class="grid cols-3" id="peopleGrid">
      ${list.map(p => `
        <div class="card" data-person="${p.id}">
          <img class="portraitImg" src="${escapeHtml(p.image)}" alt="${escapeHtml(txt(p.name))}" />
          ${renderProfileMeta(p)}
          <h2 style="margin-top:10px;">${escapeHtml(txt(p.name))}</h2>
          <div class="portraitMeta mono">${escapeHtml(t("personFile"))}</div>
        </div>
      `).join("")}
    </div>
  `;

  wireBack();

  $("peopleGrid").querySelectorAll(".card").forEach(el => {
    makeClickable(el, () => { goPersonFile(el.dataset.person); });
  });
}

function renderDocViewerLayout({ title, docs, onBackButtonLabel }){
  const unreadCount = docs.reduce((n,d) => n + (!isRead(d.id) ? 1 : 0), 0);

  app.innerHTML = `
    ${renderTopbar(title)}
    <div class="split">
      <section class="panel">
        <div class="ph">
          <h3>${escapeHtml(t("documents"))}</h3>
          <span style="color:var(--muted);font-size:12px;">
            ${escapeHtml(`${docs.length} ${t("total")} · ${unreadCount} ${t("unread")}`)}
          </span>
        </div>
        <div class="content">
          <div class="list" id="docList">
            ${
              docs.length
                ? docs.map(d => {
                    const unread = !isRead(d.id);
                    const active = d.id === state.docId;
                    return `
                      <div class="doc ${unread ? "unread" : ""} ${active ? "active" : ""}" data-doc="${d.id}">
                        <div class="docRow">
                          <div style="min-width:0;">
                            <div class="title">${escapeHtml(txt(d.title))}</div>
                            <div class="meta mono">${escapeHtml(txt(d.meta || {en:"", ar:""}))}</div>
                          </div>
                          <span class="unreadDot" title="${escapeHtml(t("unreadLabel"))}"></span>
                        </div>
                      </div>
                    `;
                  }).join("")
                : `<div style="color:var(--muted);font-size:13px;line-height:1.4;">${escapeHtml(t("emptyForNow"))}</div>`
            }
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="ph">
          <h3>${escapeHtml(t("viewer"))}</h3>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <a class="btn" id="openFullBtn" href="#" target="_blank" rel="noopener noreferrer">${escapeHtml(t("openFull"))}</a>
            <button class="btn" id="officeBtn" type="button">${escapeHtml(onBackButtonLabel || t("officeBtn"))}</button>
          </div>
        </div>
        <div class="content">
          <div class="viewerBody" id="viewerBody">
            <div class="viewStamp" id="viewStamp"></div>
          </div>
        </div>
      </section>
    </div>
  `;

  wireBack();
  $("officeBtn").addEventListener("click", back);

  const setViewerLoading = (on) => $("viewerBody").classList.toggle("loading", !!on);

  function renderViewer(){
    const body = $("viewerBody");
    const openFullBtn = $("openFullBtn");
    const doc = docs.find(d => d.id === state.docId) || null;

    if (!doc){
      body.innerHTML = `
        <div class="viewStamp" id="viewStamp"></div>
        <div style="color:var(--muted);font-size:13px;">${escapeHtml(t("selectDoc"))}</div>
      `;
      openFullBtn.style.display = "none";
      setViewerLoading(false);
      return;
    }

    setViewerLoading(true);
    openFullBtn.style.display = "none";
    openFullBtn.href = "#";

    if (doc.type === "image"){
      openFullBtn.style.display = "inline-flex";
      openFullBtn.href = doc.url;

      const img = new Image();
      img.onload = () => {
        body.innerHTML = `
          <div class="viewStamp" id="viewStamp"></div>
          <h4 style="margin:0 0 6px 0;font-size:16px;font-weight:950;">${escapeHtml(txt(doc.title))}</h4>
          <div style="color:var(--muted);font-size:12px;margin-bottom:10px;" class="mono">
            ${escapeHtml(txt(doc.meta || {en:"", ar:""}))}
          </div>
          <div class="imgWrap">
            <img src="${escapeHtml(doc.url)}" alt="${escapeHtml(txt(doc.title))}" />
          </div>
          <div class="hint mono">${escapeHtml(doc.url)}</div>
        `;
        setViewerLoading(false);
        flashViewerStamp(t("viewed"));
      };
      img.onerror = () => {
        body.innerHTML = `
          <div class="viewStamp" id="viewStamp"></div>
          <h4 style="margin:0 0 6px 0;font-size:16px;font-weight:950;">${escapeHtml(txt(doc.title))}</h4>
          <div style="color:var(--muted);font-size:12px;margin-bottom:10px;" class="mono">
            ${escapeHtml(txt(doc.meta || {en:"", ar:""}))}
          </div>
          <div style="color:var(--muted);font-size:13px;line-height:1.4;">
            ${escapeHtml(t("imageLoadError"))}
          </div>
          <div class="hint mono">${escapeHtml(doc.url)}</div>
        `;
        setViewerLoading(false);
      };
      img.src = doc.url;
      return;
    }

    const text = doc.body?.[state.lang] ?? doc.body?.en ?? "";
    body.innerHTML = `
      <div class="viewStamp" id="viewStamp"></div>
      <h4 style="margin:0 0 6px 0;font-size:16px;font-weight:950;">${escapeHtml(txt(doc.title))}</h4>
      <div style="color:var(--muted);font-size:12px;margin-bottom:10px;" class="mono">
        ${escapeHtml(txt(doc.meta || {en:"", ar:""}))}
      </div>
      <div class="imgWrap" style="padding:14px;color:var(--ink);">
        <div style="white-space:pre-wrap;line-height:1.6;font-size:13px;">${escapeHtml(text)}</div>
      </div>
    `;
    setViewerLoading(false);
    flashViewerStamp(t("viewed"));
  }

  const listRoot = $("docList");
  listRoot.querySelectorAll(".doc").forEach(el => {
    makeClickable(el, () => {
      state.docId = el.dataset.doc;
      markRead(state.docId);
      renderViewer();
      listRoot.querySelectorAll(".doc").forEach(dEl => {
        dEl.classList.toggle("active", dEl.dataset.doc === state.docId);
        dEl.classList.toggle("unread", !isRead(dEl.dataset.doc));
      });
    });
  });

  if (state.docId) markRead(state.docId);
  renderViewer();
}

function renderSection(){
  const pack = getPackForCaseKey(state.difficulty, state.caseKey);
  const sec = pack?.sections?.find(s => s.id === state.sectionId);

  if (!pack || !sec){
    app.innerHTML = `
      ${renderTopbar(t("detectiveOffice"))}
      <div class="panel">
        <div class="ph"><h3>${escapeHtml(t("detectiveOffice"))}</h3></div>
        <div class="content" style="color:var(--muted);font-size:13px;line-height:1.4;">
          ${escapeHtml(t("missing"))}
        </div>
      </div>
    `;
    wireBack();
    return;
  }

  if (isInterrogationSection(sec.id)){
    renderInterrogationRoom(pack, sec);
    return;
  }

  const docs = (pack.documents?.[state.sectionId] || []).slice();
  docs.sort((a,b) => {
    const A = (a.title?.[state.lang] ?? a.title?.en ?? "");
    const B = (b.title?.[state.lang] ?? b.title?.en ?? "");
    return A.localeCompare(B, state.lang);
  });

  if (!state.docId && docs[0]) state.docId = docs[0].id;

  renderDocViewerLayout({
    title: txt(sec.title),
    docs,
    onBackButtonLabel: t("officeBtn")
  });
}

/* ---------- COMPOUND PERSON VIEW ---------- */
function renderPerson(){
  const pack = getPackForCaseKey(state.difficulty, state.caseKey);
  const p = findPerson(pack, state.personId);
  if (!pack || !p){
    app.innerHTML = `
      ${renderTopbar(t("missing"))}
      <div class="panel">
        <div class="ph"><h3>${escapeHtml(t("missing"))}</h3></div>
        <div class="content" style="color:var(--muted);font-size:13px;line-height:1.4;">
          ${escapeHtml(t("missing"))}
        </div>
      </div>
    `;
    wireBack();
    return;
  }

  const pkg = p.package || null;
  if (!pkg){
    showToast(t("notReady"));
    back();
    return;
  }

  // Mark both parts as read as soon as the player opens the package
  if (pkg.docId) markRead(pkg.docId);
  if (pkg.vidId) markRead(pkg.vidId);

  const docTitle = pkg.docTitle ? txt(pkg.docTitle) : t("document");
  const docMeta = pkg.docMeta ? txt(pkg.docMeta) : t("packageMeta");
  const vidTitle = pkg.vidTitle ? txt(pkg.vidTitle) : t("watch");
  const vidMeta = pkg.vidMeta ? txt(pkg.vidMeta) : t("packageMeta");

  app.innerHTML = `
    ${renderTopbar(txt(p.name))}
    <div class="split">
      <section class="panel">
        <div class="ph">
          <h3>${escapeHtml(t("packageTitle"))}</h3>
          <span style="color:var(--muted);font-size:12px;" class="mono">${escapeHtml(t("packageMeta"))}</span>
        </div>
        <div class="content">
          <img class="portraitImg" src="${escapeHtml(p.image)}" alt="${escapeHtml(txt(p.name))}" />
          ${renderProfileMeta(p)}
          <div style="margin-top:10px;color:var(--muted);font-size:12px;" class="mono">
            ${escapeHtml(isRead(pkg.docId) && isRead(pkg.vidId) ? t("viewed") : "")}
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="ph">
          <h3>${escapeHtml(t("viewer"))}</h3>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <a class="btn" id="openFullBtn" href="${escapeHtml(pkg.docUrl || "#")}" target="_blank" rel="noopener noreferrer">${escapeHtml(t("openFull"))}</a>
            <button class="btn" id="officeBtn" type="button">${escapeHtml(t("back"))}</button>
          </div>
        </div>

        <div class="content">
          <div class="viewerBody" id="viewerBody">
            <div class="viewStamp" id="viewStamp"></div>

            <h4 style="margin:0 0 6px 0;font-size:16px;font-weight:950;">${escapeHtml(docTitle)}</h4>
            <div style="color:var(--muted);font-size:12px;margin-bottom:10px;" class="mono">
              ${escapeHtml(docMeta)}
            </div>

            <div class="imgWrap" id="pkgDocWrap">
              <img id="pkgDocImg" src="${escapeHtml(pkg.docUrl)}" alt="${escapeHtml(docTitle)}" />
            </div>

            <div class="compoundVideo">
              <div class="compoundVideoInner">
                <video id="pkgVideo" src="${escapeHtml(pkg.vidSrc)}" controls playsinline preload="metadata"></video>
              </div>
            </div>

            <div style="margin-top:8px;">
              <div style="margin:0 0 6px 0;font-size:14px;font-weight:950;">${escapeHtml(vidTitle)}</div>
              <div style="color:var(--muted);font-size:12px;" class="mono">${escapeHtml(vidMeta)}</div>
            </div>

            <div class="hint mono" style="margin-top:10px;">
              ${escapeHtml(pkg.docUrl)}<br/>
              ${escapeHtml(pkg.vidSrc)}
            </div>
          </div>
        </div>
      </section>
    </div>
  `;

  wireBack();
  $("officeBtn").addEventListener("click", back);

  const imgEl = $("pkgDocImg");
  const openFullBtn = $("openFullBtn");
  imgEl.addEventListener("error", () => {
    const wrap = $("pkgDocWrap");
    wrap.innerHTML = `<div style="color:var(--muted);font-size:13px;line-height:1.4;">${escapeHtml(t("imageLoadError"))}</div>`;
    openFullBtn.style.display = "none";
  });

  const videoEl = $("pkgVideo");
  if (videoEl){
    const vidId = pkg.vidId;
    videoEl.addEventListener("timeupdate", () => {
      // Consider "viewed" once the player reaches 15% of the video
      const d = videoEl.duration || 0;
      const c = videoEl.currentTime || 0;
      if (d > 0 && (c / d) > 0.15){
        if (vidId) markRead(vidId);
      }
    });
    videoEl.addEventListener("ended", () => {
      if (vidId) markRead(vidId);
      flashViewerStamp(t("viewed"));
    });
  }

  flashViewerStamp(t("viewed"));
}

/* ---------- MAIN RENDER ---------- */
function render(){
  setBackgroundForView();
  setCrumb();

  if (state.view !== "intake") voiceStop();

  if (state.view === "title") { renderTitle(); return; }
  if (state.view === "difficulty") { renderDifficulty(); return; }
  if (state.view === "cases") { renderCases(); return; }
  if (state.view === "intake") { renderIntake(); return; }
  if (state.view === "office") { renderOffice(); return; }
  if (state.view === "section") { renderSection(); return; }
  if (state.view === "person") { renderPerson(); return; }

  goTitle();
}

/* ---------- BOOT ---------- */
(function boot(){
  applyLang();
})();
  </script>
</body>
</html>











