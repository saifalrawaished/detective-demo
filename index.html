<!doctype html>
<html lang="en" id="rootHtml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detective Demo</title>

  <style>
    :root{
      --card:#121826;
      --text:#e6e8ee;
      --muted:#aab0c0;
      --accent:#6aa7ff;
      --good:#56d364;
      --warn:#ffcc66;
    }

    *{
      box-sizing:border-box;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial,
        "Noto Naskh Arabic", "Noto Sans Arabic", "Geeza Pro", "Tahoma", sans-serif;
    }

    /* ---------- IMAGE BACKGROUNDS ---------- */
    body{
      margin:0;
      color:var(--text);
      background:#000;
      min-height:100vh;
    }

    /* Home + Cases */
    body[data-bg="world"]{
      background:
        linear-gradient(rgba(0,0,0,0.55), rgba(0,0,0,0.88)),
        url("image1.jpg") center / cover no-repeat fixed;
    }

    /* Office + Section */
    body[data-bg="case"]{
      background:
        linear-gradient(rgba(0,0,0,0.65), rgba(0,0,0,0.92)),
        url("image2.jpg") center / cover no-repeat fixed;
    }

    /* Vignette + grain */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      background:
        radial-gradient(circle at 50% 35%, rgba(0,0,0,0.00) 28%, rgba(0,0,0,0.88) 82%),
        repeating-linear-gradient(
          0deg,
          rgba(255,255,255,0.016),
          rgba(255,255,255,0.016) 1px,
          transparent 1px,
          transparent 3px
        );
    }

    header, main{ position:relative; z-index:1; }

    header{
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background:rgba(0,0,0,0.45);
      backdrop-filter: blur(8px);
    }

    header h1{
      margin:0;
      font-size:16px;
      font-weight:750;
      letter-spacing:0.2px;
    }

    header .crumb{
      color:var(--muted);
      font-size:13px;
      margin-top:2px;
      max-width: 80vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .langWrap{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .langLabel{
      color:var(--muted);
      font-size:12px;
    }

    main{ padding:18px; max-width:1100px; margin:0 auto; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .topbar .left{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .btn{
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.10);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
      white-space:nowrap;
      transition: transform .08s ease, border-color .08s ease, background .08s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{
      border-color: rgba(106,167,255,0.45);
      background: rgba(0,0,0,0.35);
      transform: translateY(-1px);
    }

    .grid{ display:grid; gap:14px; }
    .grid.cols-3{ grid-template-columns:repeat(3,minmax(0,1fr)); }
    .grid.cols-5{ grid-template-columns:repeat(5,minmax(0,1fr)); }

    @media (max-width:950px){ .grid.cols-5{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
    @media (max-width:650px){
      .grid.cols-3{ grid-template-columns:1fr; }
      .grid.cols-5{ grid-template-columns:1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(18,24,38,0.88), rgba(10,13,22,0.88));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      padding:16px;
      cursor:pointer;
      transition: transform .10s ease, border-color .10s ease, box-shadow .10s ease;
      user-select:none;
      box-shadow: 0 12px 30px rgba(0,0,0,0.45);
      position:relative;
      overflow:hidden;
      min-height:92px;
      backdrop-filter: blur(6px);
    }
    .card:hover{
      transform: translateY(-3px);
      border-color: rgba(106,167,255,0.45);
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
    }
    .card h2{ margin:0 0 6px 0; font-size:16px; }
    .card p{ margin:0; color:var(--muted); font-size:13px; line-height:1.35; }

    .pill{
      display:inline-block;
      padding:4px 8px;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
      background: rgba(0,0,0,0.22);
    }

    .badge{
      position:absolute;
      top:12px;
      right:12px;
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      color:var(--muted);
      background:rgba(0,0,0,0.25);
      backdrop-filter: blur(6px);
    }
    .badge.closed{ border-color:rgba(255,204,102,0.35); color:var(--warn); }
    .badge.active{ border-color:rgba(86,211,100,0.35); color:var(--good); }

    .split{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:14px;
    }
    @media (max-width:900px){ .split{ grid-template-columns:1fr; } }

    .panel{
      background: linear-gradient(180deg, rgba(18,24,38,0.88), rgba(10,13,22,0.88));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      overflow:hidden;
      backdrop-filter: blur(6px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.45);
    }
    .panel .ph{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      background:rgba(0,0,0,0.35);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .panel .ph h3{ margin:0; font-size:14px; }
    .panel .content{ padding:12px; }

    .list{ display:flex; flex-direction:column; gap:10px; }

    .doc{
      border:1px solid rgba(255,255,255,0.10);
      border-radius:12px;
      padding:10px;
      cursor:pointer;
      background:rgba(0,0,0,0.20);
      transition: transform .08s ease, border-color .08s ease, background .08s ease;
    }
    .doc:hover{
      transform: translateY(-1px);
      border-color: rgba(106,167,255,0.45);
      background: rgba(0,0,0,0.28);
    }
    .doc.active{
      border-color: rgba(106,167,255,0.70);
      background: rgba(20,30,55,0.35);
    }
    .doc .title{ font-weight:750; font-size:13px; margin-bottom:4px; }
    .doc .meta{ color:var(--muted); font-size:12px; }

    /* ---------- IMAGE DOC VIEWER ---------- */
    .viewerTitle{ margin:0 0 8px 0; font-size:14px; font-weight:800; }
    .viewerMeta{ margin:0 0 10px 0; color:var(--muted); font-size:12px; }

    .paperStage{
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      background:rgba(0,0,0,0.28);
      padding:10px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
    }

    .paperStage img{
      width:100%;
      height:auto;
      display:block;
      border-radius:12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
    }

    /* Mobile-first: full-screen-ish viewer feel */
    .mobileStage{
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      background:rgba(0,0,0,0.22);
      padding:12px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.60);
      margin-bottom:14px;
      position:relative;
      touch-action: pan-y pinch-zoom;
    }
    .mobileStage img{
      width:100%;
      height:auto;
      display:block;
      border-radius:14px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.50);
    }

    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.78);
      border:1px solid rgba(255,255,255,0.12);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      z-index:9999;
      opacity:0;
      pointer-events:none;
      transition:opacity .12s ease;
      max-width:min(680px, calc(100% - 24px));
      backdrop-filter: blur(8px);
    }
    .toast.show{ opacity:1; }

    /* ---------- MOBILE CONTROLS (swipe-primary) ---------- */
    .mobileChrome{
      position: sticky;
      bottom: 0;
      z-index: 5;
      padding: 10px 0 0 0;
    }

    .bottomBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:rgba(0,0,0,0.55);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      padding:10px;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
    }

    .barGroup{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .counter{
      color:var(--muted);
      font-size:12px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:999px;
      background:rgba(0,0,0,0.25);
      min-width:72px;
      text-align:center;
    }

    .iconBtn{
      min-width:44px;
      height:40px;
      padding:0 12px;
      border-radius:12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }

    /* Bottom sheet */
    .sheetOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      z-index: 9990;
      display:none;
    }
    .sheetOverlay.show{ display:block; }

    .sheet{
      position:fixed;
      left:0;
      right:0;
      bottom:-100%;
      z-index: 9991;
      background:rgba(12,16,26,0.94);
      border-top:1px solid rgba(255,255,255,0.12);
      border-top-left-radius:18px;
      border-top-right-radius:18px;
      padding:12px;
      box-shadow: 0 -20px 60px rgba(0,0,0,0.70);
      transition: bottom 220ms ease;
      max-height: 70vh;
      overflow:auto;
      backdrop-filter: blur(12px);
    }
    .sheet.show{ bottom:0; }

    .sheetHandle{
      width:64px;
      height:5px;
      border-radius:999px;
      background:rgba(255,255,255,0.22);
      margin: 2px auto 10px auto;
    }

    .sheetTitle{
      font-weight:800;
      font-size:13px;
      margin:0 0 10px 0;
      color:var(--text);
    }

    /* Hide chrome class */
    .hidden{ display:none !important; }

    /* ---------- RTL SUPPORT ---------- */
    body[dir="rtl"]{ direction: rtl; }
    body[dir="rtl"] .topbar .left{ flex-direction: row-reverse; }
    body[dir="rtl"] .badge{ right:auto; left:12px; }
    body[dir="rtl"] .bottomBar{ direction: rtl; }
    body[dir="rtl"] .barGroup{ direction: rtl; }
  </style>
</head>

<body data-bg="world" dir="ltr">
  <header>
    <div>
      <h1 id="titleText">Detective Demo</h1>
      <div class="crumb" id="crumb">Home</div>
    </div>

    <div class="langWrap">
      <div class="langLabel" id="langLabel">Language</div>
      <button class="btn" id="langBtn">AR</button>
    </div>
  </header>

  <main id="app"></main>

  <div class="sheetOverlay" id="sheetOverlay"></div>
  <div class="sheet" id="sheet">
    <div class="sheetHandle"></div>
    <div class="sheetTitle" id="sheetTitle">Documents</div>
    <div id="sheetList"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /*
      Files next to index.html:
      image1.jpg
      image2.jpg
      official_police_report.jpg
      crime_scene_map.jpg
      building_exterior.jpg
      office_layout.jpg
      investigation_index1.jpg
      investigation_index2.jpg
    */

    const I18N = {
      en: {
        title: "Detective Demo",
        language: "Language",
        home: "Home",
        chooseDifficulty: "Choose difficulty",
        enter: "Enter",
        casesTitle: (d) => `${cap(d)} cases`,
        navigate: "Navigate the case files",
        back: "Back",
        homeBtn: "Home",
        available: "Available",
        closed: "Closed",
        open: "Open",
        locked: "Locked",
        notAvailable: "Not available yet.",
        openCaseFile: "Open the case file.",
        closedToast: "Closed. Not available yet.",
        detectiveOffice: "Detective Office",
        openDrawer: "Open this drawer.",
        documents: "Documents",
        viewer: "Viewer",
        items: (n) => `${n} item(s)`,
        emptyForNow: "Empty for now.",
        selectDoc: "Select a document.",
        officeBtn: "Detective Office",
        openFull: "Open full image",
        missing: "This case is not configured yet.",
        list: "List",
        prev: "Prev",
        next: "Next",
        tapHint: "Tip: swipe left/right to flip documents. Tap to hide/show controls."
      },
      ar: {
        title: "لعبة المحقق",
        language: "اللغة",
        home: "الرئيسية",
        chooseDifficulty: "اختر مستوى الصعوبة",
        enter: "دخول",
        casesTitle: (d) => `قضايا ${capAr(d)}`,
        navigate: "تصفح ملفات القضية",
        back: "رجوع",
        homeBtn: "الرئيسية",
        available: "متاحة",
        closed: "مغلقة",
        open: "فتح",
        locked: "مقفلة",
        notAvailable: "غير متاحة حاليا.",
        openCaseFile: "افتح ملف القضية.",
        closedToast: "مغلقة. غير متاحة حاليا.",
        detectiveOffice: "مكتب المحقق",
        openDrawer: "افتح هذا الدرج.",
        documents: "المستندات",
        viewer: "المعاينة",
        items: (n) => `${n} عنصر`,
        emptyForNow: "فارغة حاليا.",
        selectDoc: "اختر مستندا.",
        officeBtn: "مكتب المحقق",
        openFull: "افتح الصورة كاملة",
        missing: "هذه القضية غير مفعلة بعد.",
        list: "قائمة",
        prev: "السابق",
        next: "التالي",
        tapHint: "معلومة: اسحب يمينا ويسارا للتنقل. اضغط لإظهار وإخفاء الأزرار."
      }
    };

    function cap(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : ""; }
    function capAr(d){
      if (d === "easy") return "السهلة";
      if (d === "medium") return "المتوسطة";
      if (d === "hard") return "الصعبة";
      return d || "";
    }

    const storageKey = "detective_lang";

    const uiState = {
      chromeOn: true,      // for mobile section viewer
      sheetOpen: false,
      touchStartX: null,
      touchStartY: null,
      touchStartT: null
    };

    const state = {
      lang: (localStorage.getItem(storageKey) === "ar") ? "ar" : "en",
      view: "home",         // home | cases | office | section
      difficulty: null,     // easy | medium | hard
      caseId: null,         // easy_case_1 ...
      sectionId: null,      // objectives ...
      docId: null           // ir_map ...
    };

    function t(key, ...args){
      const dict = I18N[state.lang];
      const val = dict[key];
      return (typeof val === "function") ? val(...args) : val;
    }
    function txt(obj){ return obj && obj[state.lang] ? obj[state.lang] : (obj?.en ?? ""); }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    const GAME = {
      difficulties: [
        { id: "easy", title: { en: "Easy", ar: "سهل" }, desc: { en: "Entry level cases.", ar: "قضايا للمبتدئين." } },
        { id: "medium", title: { en: "Medium", ar: "متوسط" }, desc: { en: "More noise and contradictions.", ar: "مزيد من الضوضاء والتناقضات." } },
        { id: "hard", title: { en: "Hard", ar: "صعب" }, desc: { en: "Dense files, ambiguity.", ar: "ملفات كثيفة وغموض." } }
      ],

      casesByDifficulty: {
        easy: Array.from({ length: 10 }, (_, i) => ({
          id: `easy_case_${i+1}`,
          label: { en: `Case ${i+1}`, ar: `القضية ${i+1}` },
          status: (i === 0) ? "active" : "closed"
        })),
        medium: Array.from({ length: 10 }, (_, i) => ({
          id: `med_case_${i+1}`,
          label: { en: `Case ${i+1}`, ar: `القضية ${i+1}` },
          status: "closed"
        })),
        hard: Array.from({ length: 10 }, (_, i) => ({
          id: `hard_case_${i+1}`,
          label: { en: `Case ${i+1}`, ar: `القضية ${i+1}` },
          status: "closed"
        }))
      },

      caseContent: {
        easy_case_1: {
          officeTitle: { en: "Detective Office", ar: "مكتب المحقق" },
          sections: [
            { id: "objectives", title: { en: "Case Objectives", ar: "أهداف القضية" } },
            { id: "initial_report", title: { en: "Initial Report", ar: "البلاغ الأولي" } },
            { id: "first_file", title: { en: "First File", ar: "الملف الأول" } },
            { id: "second_file", title: { en: "Second File", ar: "الملف الثاني" } },
            { id: "additional_evidence", title: { en: "Additional evidences", ar: "أدلة إضافية" } }
          ],
          documents: {
            objectives: [
              { id:"obj_1", title:{en:"Objectives (placeholder)", ar:"الأهداف (مكان مخصص)"}, meta:{en:"Add later", ar:"أضف لاحقا"}, type:"text", body:{en:"Add objectives here later.", ar:"أضف الأهداف هنا لاحقا."} }
            ],

            initial_report: [
              { id:"ir_map", title:{en:"Crime Scene Map", ar:"خريطة مواقع"}, meta:{en:"Image document", ar:"صورة"}, type:"image", url:"crime_scene_map.jpg" },
              { id:"ir_building", title:{en:"Building Exterior", ar:"الواجهة الخارجية"}, meta:{en:"Image document", ar:"صورة"}, type:"image", url:"building_exterior.jpg" },
              { id:"ir_layout", title:{en:"Office Layout", ar:"مخطط المكتب"}, meta:{en:"Image document", ar:"صورة"}, type:"image", url:"office_layout.jpg" },
              { id:"ir_index_1", title:{en:"Investigation Index (1)", ar:"فهرس المستندات (1)"}, meta:{en:"Image document", ar:"صورة"}, type:"image", url:"investigation_index1.jpg" },
              { id:"ir_index_2", title:{en:"Investigation Index (2)", ar:"فهرس المستندات (2)"}, meta:{en:"Image document", ar:"صورة"}, type:"image", url:"investigation_index2.jpg" },
              { id:"ir_police", title:{en:"Official Police Report", ar:"محضر الشرطة"}, meta:{en:"Image document", ar:"صورة"}, type:"image", url:"official_police_report.jpg" }
            ],

            first_file: [
              { id:"ff_placeholder", title:{en:"First File (empty)", ar:"الملف الأول (فارغ)"}, meta:{en:"Add files later", ar:"أضف ملفات لاحقا"}, type:"text", body:{en:"No documents yet.", ar:"لا توجد مستندات بعد."} }
            ],

            second_file: [
              { id:"sf_placeholder", title:{en:"Second File (empty)", ar:"الملف الثاني (فارغ)"}, meta:{en:"Add files later", ar:"أضف ملفات لاحقا"}, type:"text", body:{en:"No documents yet.", ar:"لا توجد مستندات بعد."} }
            ],

            additional_evidence: [
              { id:"ae_placeholder", title:{en:"Additional evidences (empty)", ar:"أدلة إضافية (فارغ)"}, meta:{en:"Add files later", ar:"أضف ملفات لاحقا"}, type:"text", body:{en:"No documents yet.", ar:"لا توجد مستندات بعد."} }
            ]
          }
        }
      }
    };

    const rootHtml = document.getElementById("rootHtml");
    const app = document.getElementById("app");
    const crumb = document.getElementById("crumb");
    const toastEl = document.getElementById("toast");
    const titleText = document.getElementById("titleText");
    const langLabel = document.getElementById("langLabel");
    const langBtn = document.getElementById("langBtn");

    const sheetOverlay = document.getElementById("sheetOverlay");
    const sheet = document.getElementById("sheet");
    const sheetTitle = document.getElementById("sheetTitle");
    const sheetList = document.getElementById("sheetList");

    function isMobile(){
      return window.matchMedia("(max-width: 900px)").matches;
    }

    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      window.clearTimeout(showToast._t);
      showToast._t = window.setTimeout(() => toastEl.classList.remove("show"), 1400);
    }

    function applyLang(){
      const isAr = state.lang === "ar";
      document.body.setAttribute("dir", isAr ? "rtl" : "ltr");
      rootHtml.setAttribute("lang", isAr ? "ar" : "en");
      titleText.textContent = t("title");
      langLabel.textContent = t("language");
      langBtn.textContent = isAr ? "EN" : "AR";
      render();
    }

    langBtn.addEventListener("click", () => {
      state.lang = (state.lang === "en") ? "ar" : "en";
      localStorage.setItem(storageKey, state.lang);
      applyLang();
    });

    function goHome(){
      state.view = "home";
      state.difficulty = null;
      state.caseId = null;
      state.sectionId = null;
      state.docId = null;
      uiState.chromeOn = true;
      closeSheet();
      render();
    }

    function goCases(difficulty){
      state.view = "cases";
      state.difficulty = difficulty;
      state.caseId = null;
      state.sectionId = null;
      state.docId = null;
      uiState.chromeOn = true;
      closeSheet();
      render();
    }

    function goOffice(caseId){
      state.view = "office";
      state.caseId = caseId;
      state.sectionId = null;
      state.docId = null;
      uiState.chromeOn = true;
      closeSheet();
      render();
    }

    function goSection(sectionId){
      state.view = "section";
      state.sectionId = sectionId;
      state.docId = null; // reset to first doc
      uiState.chromeOn = true;
      closeSheet();
      render();
    }

    function back(){
      closeSheet();
      if (state.view === "section") { state.view = "office"; state.sectionId = null; state.docId = null; render(); return; }
      if (state.view === "office") { state.view = "cases"; state.caseId = null; render(); return; }
      if (state.view === "cases") { goHome(); return; }
      goHome();
    }

    function currentContext(){
      const c = GAME.caseContent[state.caseId] || null;
      const sec = c ? c.sections.find(s => s.id === state.sectionId) : null;
      const docs = c && state.sectionId ? (c.documents[state.sectionId] || []) : [];
      return { c, sec, docs };
    }

    function docIndexById(docs, docId){
      const idx = docs.findIndex(d => d.id === docId);
      return idx >= 0 ? idx : 0;
    }

    function setDocByIndex(docs, idx){
      if (!docs.length) return;
      const clamped = Math.max(0, Math.min(docs.length - 1, idx));
      state.docId = docs[clamped].id;
      renderViewerOnly();
      updateSheetHighlight();
    }

    function nextDoc(){
      const { docs } = currentContext();
      if (!docs.length) return;
      const idx = docIndexById(docs, state.docId);
      if (idx >= docs.length - 1) return;
      setDocByIndex(docs, idx + 1);
    }

    function prevDoc(){
      const { docs } = currentContext();
      if (!docs.length) return;
      const idx = docIndexById(docs, state.docId);
      if (idx <= 0) return;
      setDocByIndex(docs, idx - 1);
    }

    function openSheet(){
      uiState.sheetOpen = true;
      sheetOverlay.classList.add("show");
      sheet.classList.add("show");
    }

    function closeSheet(){
      uiState.sheetOpen = false;
      sheetOverlay.classList.remove("show");
      sheet.classList.remove("show");
    }

    sheetOverlay.addEventListener("click", closeSheet);

    // Allow swipe down on sheet to close (simple)
    let sheetTouchStartY = null;
    sheet.addEventListener("touchstart", (e) => {
      if (!e.touches || !e.touches.length) return;
      sheetTouchStartY = e.touches[0].clientY;
    }, { passive:true });
    sheet.addEventListener("touchend", (e) => {
      if (sheetTouchStartY == null) return;
      const endY = (e.changedTouches && e.changedTouches.length) ? e.changedTouches[0].clientY : null;
      if (endY != null && (endY - sheetTouchStartY) > 60) closeSheet();
      sheetTouchStartY = null;
    }, { passive:true });

    function renderTopbar(titleRight){
      const left = `
        <div class="left">
          ${state.view === "home" ? "" : `<button class="btn" id="backBtn">${escapeHtml(t("back"))}</button>`}
          <div style="display:flex;flex-direction:column;gap:2px;">
            <div style="font-weight:750;font-size:14px;">${escapeHtml(titleRight)}</div>
            <div style="color:var(--muted);font-size:12px;">${escapeHtml(t("navigate"))}</div>
          </div>
        </div>
      `;
      const right = `
        <div style="display:flex;gap:10px;align-items:center;">
          ${state.view === "home" ? "" : `<button class="btn" id="homeBtn">${escapeHtml(t("homeBtn"))}</button>`}
        </div>
      `;
      return `<div class="topbar">${left}${right}</div>`;
    }

    function wireCommonButtons(){
      const backBtn = document.getElementById("backBtn");
      if (backBtn) backBtn.addEventListener("click", back);

      const homeBtn = document.getElementById("homeBtn");
      if (homeBtn) homeBtn.addEventListener("click", goHome);
    }

    function render(){
      document.body.setAttribute("data-bg", (state.view === "home" || state.view === "cases") ? "world" : "case");

      const diffObj = GAME.difficulties.find(d => d.id === state.difficulty);
      const diffName = diffObj ? txt(diffObj.title) : "";

      if (state.view === "home") crumb.textContent = t("home");
      if (state.view === "cases") crumb.textContent = `${t("home")} / ${diffName}`;
      if (state.view === "office") crumb.textContent = `${t("home")} / ${diffName} / ${txt({en:"Case 1", ar:"القضية 1"})} / ${t("detectiveOffice")}`;
      if (state.view === "section") {
        const { c, sec } = currentContext();
        crumb.textContent = `${t("home")} / ${diffName} / ${txt({en:"Case 1", ar:"القضية 1"})} / ${t("detectiveOffice")} / ${sec ? txt(sec.title) : ""}`;
      }

      if (state.view === "home"){
        app.innerHTML = `
          ${renderTopbar(t("chooseDifficulty"))}
          <div class="grid cols-3">
            ${GAME.difficulties.map(d => `
              <div class="card" data-diff="${d.id}">
                <h2>${escapeHtml(txt(d.title))}</h2>
                <p>${escapeHtml(txt(d.desc))}</p>
                <div class="pill">${escapeHtml(t("enter"))}</div>
              </div>
            `).join("")}
          </div>
        `;
        app.querySelectorAll(".card").forEach(el => el.addEventListener("click", () => goCases(el.dataset.diff)));
        return;
      }

      if (state.view === "cases"){
        const list = GAME.casesByDifficulty[state.difficulty] || [];
        app.innerHTML = `
          ${renderTopbar(t("casesTitle", state.difficulty))}
          <div class="grid cols-5">
            ${list.map(c => `
              <div class="card" data-case="${c.id}" data-status="${c.status}">
                <div class="badge ${c.status}">${escapeHtml(c.status === "active" ? t("available") : t("closed"))}</div>
                <h2>${escapeHtml(txt(c.label))}</h2>
                <p>${escapeHtml(c.status === "active" ? t("openCaseFile") : t("notAvailable"))}</p>
                <div class="pill">${escapeHtml(c.status === "active" ? t("open") : t("locked"))}</div>
              </div>
            `).join("")}
          </div>
        `;
        wireCommonButtons();
        app.querySelectorAll(".card").forEach(el => {
          el.addEventListener("click", () => {
            if (el.dataset.status !== "active") { showToast(t("closedToast")); return; }
            goOffice(el.dataset.case);
          });
        });
        return;
      }

      if (state.view === "office"){
        const c = GAME.caseContent[state.caseId];
        if (!c){
          app.innerHTML = `
            ${renderTopbar(t("detectiveOffice"))}
            <div class="panel">
              <div class="ph"><h3>${escapeHtml(t("detectiveOffice"))}</h3></div>
              <div class="content" style="color:var(--muted);font-size:13px;line-height:1.4;">
                ${escapeHtml(t("missing"))}
              </div>
            </div>
          `;
          wireCommonButtons();
          return;
        }

        app.innerHTML = `
          ${renderTopbar(txt(c.officeTitle))}
          <div class="grid cols-5">
            ${c.sections.map(s => `
              <div class="card" data-section="${s.id}">
                <div class="badge active">${escapeHtml(t("open"))}</div>
                <h2>${escapeHtml(txt(s.title))}</h2>
                <p>${escapeHtml(t("openDrawer"))}</p>
                <div class="pill">${escapeHtml(t("enter"))}</div>
              </div>
            `).join("")}
          </div>
        `;
        wireCommonButtons();
        app.querySelectorAll(".card").forEach(el => el.addEventListener("click", () => goSection(el.dataset.section)));
        return;
      }

      if (state.view === "section"){
        const { c, sec, docs } = currentContext();

        if (!docs.length){
          app.innerHTML = `
            ${renderTopbar(sec ? txt(sec.title) : "")}
            <div class="panel">
              <div class="ph"><h3>${escapeHtml(t("documents"))}</h3></div>
              <div class="content" style="color:var(--muted);font-size:13px;line-height:1.4;">
                ${escapeHtml(t("emptyForNow"))}
              </div>
            </div>
          `;
          wireCommonButtons();
          return;
        }

        // default to first doc
        if (!state.docId) state.docId = docs[0].id;

        // Build desktop vs mobile section UI
        if (!isMobile()){
          app.innerHTML = `
            ${renderTopbar(txt(sec.title))}
            <div class="split">
              <section class="panel">
                <div class="ph">
                  <h3>${escapeHtml(t("documents"))}</h3>
                  <span style="color:var(--muted);font-size:12px;">${escapeHtml(t("items", docs.length))}</span>
                </div>
                <div class="content">
                  <div class="list" id="desktopList">
                    ${docs.map(d => `
                      <div class="doc ${d.id === state.docId ? "active" : ""}" data-doc="${d.id}">
                        <div class="title">${escapeHtml(txt(d.title))}</div>
                        <div class="meta">${escapeHtml(txt(d.meta || {en:"", ar:""}))}</div>
                      </div>
                    `).join("")}
                  </div>
                </div>
              </section>

              <section class="panel">
                <div class="ph">
                  <h3>${escapeHtml(t("viewer"))}</h3>
                  <div style="display:flex;gap:8px;align-items:center;">
                    <a class="btn" id="openFullBtn" href="#" target="_blank" rel="noopener noreferrer">${escapeHtml(t("openFull"))}</a>
                    <button class="btn" id="officeBtn">${escapeHtml(t("officeBtn"))}</button>
                  </div>
                </div>
                <div class="content" id="viewer"></div>
              </section>
            </div>
          `;

          wireCommonButtons();
          document.getElementById("officeBtn").addEventListener("click", back);

          document.querySelectorAll("#desktopList .doc").forEach(el => {
            el.addEventListener("click", () => {
              state.docId = el.dataset.doc;
              renderViewerOnly();
            });
          });

          renderViewerOnly();
          closeSheet();
          return;
        }

        // Mobile section UI (swipe-primary)
        app.innerHTML = `
          ${renderTopbar(txt(sec.title))}
          <div id="mobileViewerRoot">
            <div id="mobileViewer"></div>

            <div class="mobileChrome ${uiState.chromeOn ? "" : "hidden"}" id="mobileChrome">
              <div class="bottomBar">
                <div class="barGroup">
                  <button class="btn iconBtn" id="prevBtn">${escapeHtml(t("prev"))}</button>
                  <div class="counter" id="counter">1 / ${docs.length}</div>
                  <button class="btn iconBtn" id="nextBtn">${escapeHtml(t("next"))}</button>
                </div>

                <div class="barGroup">
                  <a class="btn iconBtn" id="openFullBtn" href="#" target="_blank" rel="noopener noreferrer">${escapeHtml(t("openFull"))}</a>
                  <button class="btn iconBtn" id="listBtn">${escapeHtml(t("list"))}</button>
                  <button class="btn iconBtn" id="officeBtn">${escapeHtml(t("officeBtn"))}</button>
                </div>
              </div>
              <div class="hint">${escapeHtml(t("tapHint"))}</div>
            </div>
          </div>
        `;

        wireCommonButtons();

        document.getElementById("officeBtn").addEventListener("click", back);
        document.getElementById("listBtn").addEventListener("click", () => {
          buildSheetList();
          openSheet();
        });

        document.getElementById("prevBtn").addEventListener("click", prevDoc);
        document.getElementById("nextBtn").addEventListener("click", nextDoc);

        // Tap to toggle chrome and swipe to flip
        const mobileViewer = document.getElementById("mobileViewer");
        mobileViewer.addEventListener("click", (e) => {
          if (uiState.sheetOpen) return;
          uiState.chromeOn = !uiState.chromeOn;
          const chrome = document.getElementById("mobileChrome");
          if (chrome) chrome.classList.toggle("hidden", !uiState.chromeOn);
        });

        mobileViewer.addEventListener("touchstart", (e) => {
          if (uiState.sheetOpen) return;
          if (!e.touches || e.touches.length !== 1) return;
          const t0 = e.touches[0];
          uiState.touchStartX = t0.clientX;
          uiState.touchStartY = t0.clientY;
          uiState.touchStartT = Date.now();
        }, { passive:true });

        mobileViewer.addEventListener("touchend", (e) => {
          if (uiState.sheetOpen) return;
          if (uiState.touchStartX == null) return;

          const end = (e.changedTouches && e.changedTouches.length) ? e.changedTouches[0] : null;
          if (!end) { uiState.touchStartX = null; return; }

          const dx = end.clientX - uiState.touchStartX;
          const dy = end.clientY - uiState.touchStartY;
          const dt = Date.now() - uiState.touchStartT;

          uiState.touchStartX = null;
          uiState.touchStartY = null;
          uiState.touchStartT = null;

          // Swipe detection: mostly horizontal, enough distance, quick enough
          if (Math.abs(dx) < 45) return;
          if (Math.abs(dx) < Math.abs(dy)) return;
          if (dt > 650) return;

          // LTR: swipe left => next. RTL: still keep physical rule: swipe left => next.
          if (dx < 0) nextDoc();
          else prevDoc();
        }, { passive:true });

        buildSheetList();
        renderViewerOnly();
        return;
      }
    }

    function buildSheetList(){
      const { sec, docs } = currentContext();
      sheetTitle.textContent = `${t("documents")} • ${sec ? txt(sec.title) : ""}`;

      sheetList.innerHTML = `
        <div class="list">
          ${docs.map(d => `
            <div class="doc ${d.id === state.docId ? "active" : ""}" data-doc="${d.id}">
              <div class="title">${escapeHtml(txt(d.title))}</div>
              <div class="meta">${escapeHtml(txt(d.meta || {en:"", ar:""}))}</div>
            </div>
          `).join("")}
        </div>
      `;

      sheetList.querySelectorAll(".doc").forEach(el => {
        el.addEventListener("click", () => {
          const { docs } = currentContext();
          state.docId = el.dataset.doc;
          closeSheet();
          renderViewerOnly();
          updateSheetHighlight();
        });
      });
    }

    function updateSheetHighlight(){
      if (!sheetList) return;
      sheetList.querySelectorAll(".doc").forEach(el => {
        el.classList.toggle("active", el.dataset.doc === state.docId);
      });
    }

    function renderViewerOnly(){
      if (state.view !== "section") return;

      const { docs } = currentContext();
      if (!docs.length) return;

      const idx = docIndexById(docs, state.docId);
      const doc = docs[idx] || docs[0];

      // Desktop viewer
      const viewer = document.getElementById("viewer");
      const openFullBtnDesktop = document.getElementById("openFullBtn");

      // Mobile viewer
      const mobileViewer = document.getElementById("mobileViewer");
      const openFullBtnMobile = document.getElementById("openFullBtn");
      const counter = document.getElementById("counter");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      // Update desktop list highlight if present
      const desktopList = document.getElementById("desktopList");
      if (desktopList){
        desktopList.querySelectorAll(".doc").forEach(el => {
          el.classList.toggle("active", el.dataset.doc === doc.id);
        });
      }

      // Update mobile counter and button states
      if (counter) counter.textContent = `${idx + 1} / ${docs.length}`;
      if (prevBtn) prevBtn.disabled = (idx === 0);
      if (nextBtn) nextBtn.disabled = (idx === docs.length - 1);

      const title = escapeHtml(txt(doc.title));
      const meta = escapeHtml(txt(doc.meta || {en:"", ar:""}));

      const isImage = doc.type === "image";
      const isLink = doc.type === "link";
      const url = doc.url || "";

      const fullHref = isImage || isLink ? url : "#";

      // Desktop open full
      if (openFullBtnDesktop){
        openFullBtnDesktop.style.display = (isImage || isLink) ? "inline-flex" : "none";
        openFullBtnDesktop.href = fullHref;
      }
      // Mobile open full
      if (openFullBtnMobile){
        openFullBtnMobile.style.display = (isImage || isLink) ? "inline-flex" : "none";
        openFullBtnMobile.href = fullHref;
      }

      // Render image as paper
      if (isImage){
        const html = `
          <div class="viewerTitle">${title}</div>
          <div class="viewerMeta">${meta}</div>
          <div class="${isMobile() ? "mobileStage" : "paperStage"}">
            <img src="${escapeHtml(url)}" alt="${title}" />
          </div>
        `;
        if (viewer) viewer.innerHTML = html;
        if (mobileViewer) mobileViewer.innerHTML = html;
        updateSheetHighlight();
        return;
      }

      // Link
      if (isLink){
        const html = `
          <div class="viewerTitle">${title}</div>
          <div class="viewerMeta">${meta}</div>
          <div class="${isMobile() ? "mobileStage" : "paperStage"}" style="padding:14px;">
            <div style="color:var(--muted);font-size:13px;line-height:1.5;">
              <a class="btn" href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(t("openFull"))}</a>
            </div>
          </div>
        `;
        if (viewer) viewer.innerHTML = html;
        if (mobileViewer) mobileViewer.innerHTML = html;
        updateSheetHighlight();
        return;
      }

      // Text fallback (kept for other sections)
      const body = doc.body?.[state.lang] ?? doc.body?.en ?? "";
      const html = `
        <div class="viewerTitle">${title}</div>
        <div class="viewerMeta">${meta}</div>
        <div class="${isMobile() ? "mobileStage" : "paperStage"}" style="padding:14px;">
          <div style="white-space:pre-wrap;line-height:1.55;font-size:13px;">${escapeHtml(body)}</div>
        </div>
      `;
      if (viewer) viewer.innerHTML = html;
      if (mobileViewer) mobileViewer.innerHTML = html;
      updateSheetHighlight();
    }

    // Rerender on resize so mobile/desktop layout switches cleanly
    window.addEventListener("resize", () => {
      if (state.view === "section") {
        closeSheet();
        render();
      }
    });

    applyLang();
  </script>
</body>
</html>


